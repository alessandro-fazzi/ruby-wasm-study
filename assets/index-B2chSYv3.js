(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const r of t.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(o){if(o.ep)return;o.ep=!0;const t=n(o);fetch(o.href,t)}})();const ne=0,re=1,m=0,p=8,M=20,W=28,se=31,ke=37,A=44,Oe=52,k=54,ie=55,w=58,Q=63,ae=76,oe=64;class L{static read_bytes(e,n){const s=new L;return s.buf=e.getUint32(n,!0),s.buf_len=e.getUint32(n+4,!0),s}static read_bytes_array(e,n,s){const o=[];for(let t=0;t<s;t++)o.push(L.read_bytes(e,n+8*t));return o}}class C{static read_bytes(e,n){const s=new C;return s.buf=e.getUint32(n,!0),s.buf_len=e.getUint32(n+4,!0),s}static read_bytes_array(e,n,s){const o=[];for(let t=0;t<s;t++)o.push(C.read_bytes(e,n+8*t));return o}}const Pe=0,Ae=1,he=2,j=3,q=4;class Y{head_length(){return 24}name_length(){return this.dir_name.byteLength}write_head_bytes(e,n){e.setBigUint64(n,this.d_next,!0),e.setBigUint64(n+8,this.d_ino,!0),e.setUint32(n+16,this.dir_name.length,!0),e.setUint8(n+20,this.d_type)}write_name_bytes(e,n,s){e.set(this.dir_name.slice(0,Math.min(this.dir_name.byteLength,s)),n)}constructor(e,n,s){this.d_ino=0n;const o=new TextEncoder().encode(n);this.d_next=e,this.d_namlen=o.byteLength,this.d_type=s,this.dir_name=o}}const Fe=1;class be{write_bytes(e,n){e.setUint8(n,this.fs_filetype),e.setUint16(n+2,this.fs_flags,!0),e.setBigUint64(n+8,this.fs_rights_base,!0),e.setBigUint64(n+16,this.fs_rights_inherited,!0)}constructor(e,n){this.fs_rights_base=0n,this.fs_rights_inherited=0n,this.fs_filetype=e,this.fs_flags=n}}const K=1,V=2,le=4,ue=8;class _e{write_bytes(e,n){e.setBigUint64(n,this.dev,!0),e.setBigUint64(n+8,this.ino,!0),e.setUint8(n+16,this.filetype),e.setBigUint64(n+24,this.nlink,!0),e.setBigUint64(n+32,this.size,!0),e.setBigUint64(n+38,this.atim,!0),e.setBigUint64(n+46,this.mtim,!0),e.setBigUint64(n+52,this.ctim,!0)}constructor(e,n){this.dev=0n,this.ino=0n,this.nlink=0n,this.atim=0n,this.mtim=0n,this.ctim=0n,this.filetype=e,this.size=n}}const Se=0;class De{write_bytes(e,n){e.setUint32(n,this.pr_name.byteLength,!0)}constructor(e){this.pr_name=new TextEncoder().encode(e)}}class Z{static dir(e){const n=new Z;return n.tag=Se,n.inner=new De(e),n}write_bytes(e,n){e.setUint32(n,this.tag,!0),this.inner.write_bytes(e,n+4)}}let Ve=class{enable(e){this.log=Ne(e===void 0?!0:e,this.prefix)}get enabled(){return this.isEnabled}constructor(e){this.isEnabled=e,this.prefix="wasi:",this.enable(e)}};function Ne(u,e){return u?console.log.bind(console,"%c%s","color: #265BA0",e):()=>{}}const x=new Ve(!1);class ce extends Error{constructor(e){super("exit with exit code "+e),this.code=e}}let Be=class{start(e){this.inst=e;try{return e.exports._start(),0}catch(n){if(n instanceof ce)return n.code;throw n}}initialize(e){this.inst=e,e.exports._initialize&&e.exports._initialize()}constructor(e,n,s,o={}){this.args=[],this.env=[],this.fds=[],x.enable(o.debug),this.args=e,this.env=n,this.fds=s;const t=this;this.wasiImport={args_sizes_get(r,i){const a=new DataView(t.inst.exports.memory.buffer);a.setUint32(r,t.args.length,!0);let l=0;for(const c of t.args)l+=c.length+1;return a.setUint32(i,l,!0),x.log(a.getUint32(r,!0),a.getUint32(i,!0)),0},args_get(r,i){const a=new DataView(t.inst.exports.memory.buffer),l=new Uint8Array(t.inst.exports.memory.buffer),c=i;for(let f=0;f<t.args.length;f++){a.setUint32(r,i,!0),r+=4;const d=new TextEncoder().encode(t.args[f]);l.set(d,i),a.setUint8(i+d.length,0),i+=d.length+1}return x.enabled&&x.log(new TextDecoder("utf-8").decode(l.slice(c,i))),0},environ_sizes_get(r,i){const a=new DataView(t.inst.exports.memory.buffer);a.setUint32(r,t.env.length,!0);let l=0;for(const c of t.env)l+=c.length+1;return a.setUint32(i,l,!0),x.log(a.getUint32(r,!0),a.getUint32(i,!0)),0},environ_get(r,i){const a=new DataView(t.inst.exports.memory.buffer),l=new Uint8Array(t.inst.exports.memory.buffer),c=i;for(let f=0;f<t.env.length;f++){a.setUint32(r,i,!0),r+=4;const d=new TextEncoder().encode(t.env[f]);l.set(d,i),a.setUint8(i+d.length,0),i+=d.length+1}return x.enabled&&x.log(new TextDecoder("utf-8").decode(l.slice(c,i))),0},clock_res_get(r,i){let a;switch(r){case re:{a=5000n;break}case ne:{a=1000000n;break}default:return Oe}return new DataView(t.inst.exports.memory.buffer).setBigUint64(i,a,!0),m},clock_time_get(r,i,a){const l=new DataView(t.inst.exports.memory.buffer);if(r===ne)l.setBigUint64(a,BigInt(new Date().getTime())*1000000n,!0);else if(r==re){let c;try{c=BigInt(Math.round(performance.now()*1e6))}catch{c=0n}l.setBigUint64(a,c,!0)}else l.setBigUint64(a,0n,!0);return 0},fd_advise(r,i,a,l){return t.fds[r]!=null?m:p},fd_allocate(r,i,a){return t.fds[r]!=null?t.fds[r].fd_allocate(i,a):p},fd_close(r){if(t.fds[r]!=null){const i=t.fds[r].fd_close();return t.fds[r]=void 0,i}else return p},fd_datasync(r){return t.fds[r]!=null?t.fds[r].fd_sync():p},fd_fdstat_get(r,i){if(t.fds[r]!=null){const{ret:a,fdstat:l}=t.fds[r].fd_fdstat_get();return l?.write_bytes(new DataView(t.inst.exports.memory.buffer),i),a}else return p},fd_fdstat_set_flags(r,i){return t.fds[r]!=null?t.fds[r].fd_fdstat_set_flags(i):p},fd_fdstat_set_rights(r,i,a){return t.fds[r]!=null?t.fds[r].fd_fdstat_set_rights(i,a):p},fd_filestat_get(r,i){if(t.fds[r]!=null){const{ret:a,filestat:l}=t.fds[r].fd_filestat_get();return l?.write_bytes(new DataView(t.inst.exports.memory.buffer),i),a}else return p},fd_filestat_set_size(r,i){return t.fds[r]!=null?t.fds[r].fd_filestat_set_size(i):p},fd_filestat_set_times(r,i,a,l){return t.fds[r]!=null?t.fds[r].fd_filestat_set_times(i,a,l):p},fd_pread(r,i,a,l,c){const f=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const h=L.read_bytes_array(f,i,a);let _=0;for(const b of h){const{ret:y,data:v}=t.fds[r].fd_pread(b.buf_len,l);if(y!=m)return f.setUint32(c,_,!0),y;if(d.set(v,b.buf),_+=v.length,l+=BigInt(v.length),v.length!=b.buf_len)break}return f.setUint32(c,_,!0),m}else return p},fd_prestat_get(r,i){const a=new DataView(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const{ret:l,prestat:c}=t.fds[r].fd_prestat_get();return c?.write_bytes(a,i),l}else return p},fd_prestat_dir_name(r,i,a){if(t.fds[r]!=null){const{ret:l,prestat:c}=t.fds[r].fd_prestat_get();if(c==null)return l;const f=c.inner.pr_name;return new Uint8Array(t.inst.exports.memory.buffer).set(f.slice(0,a),i),f.byteLength>a?ke:m}else return p},fd_pwrite(r,i,a,l,c){const f=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const h=C.read_bytes_array(f,i,a);let _=0;for(const b of h){const y=d.slice(b.buf,b.buf+b.buf_len),{ret:v,nwritten:I}=t.fds[r].fd_pwrite(y,l);if(v!=m)return f.setUint32(c,_,!0),v;if(_+=I,l+=BigInt(I),I!=y.byteLength)break}return f.setUint32(c,_,!0),m}else return p},fd_read(r,i,a,l){const c=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const d=L.read_bytes_array(c,i,a);let h=0;for(const _ of d){const{ret:b,data:y}=t.fds[r].fd_read(_.buf_len);if(b!=m)return c.setUint32(l,h,!0),b;if(f.set(y,_.buf),h+=y.length,y.length!=_.buf_len)break}return c.setUint32(l,h,!0),m}else return p},fd_readdir(r,i,a,l,c){const f=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){let h=0;for(;;){const{ret:_,dirent:b}=t.fds[r].fd_readdir_single(l);if(_!=0)return f.setUint32(c,h,!0),_;if(b==null)break;if(a-h<b.head_length()){h=a;break}const y=new ArrayBuffer(b.head_length());if(b.write_head_bytes(new DataView(y),0),d.set(new Uint8Array(y).slice(0,Math.min(y.byteLength,a-h)),i),i+=b.head_length(),h+=b.head_length(),a-h<b.name_length()){h=a;break}b.write_name_bytes(d,i,a-h),i+=b.name_length(),h+=b.name_length(),l=b.d_next}return f.setUint32(c,h,!0),0}else return p},fd_renumber(r,i){if(t.fds[r]!=null&&t.fds[i]!=null){const a=t.fds[i].fd_close();return a!=0?a:(t.fds[i]=t.fds[r],t.fds[r]=void 0,0)}else return p},fd_seek(r,i,a,l){const c=new DataView(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const{ret:f,offset:d}=t.fds[r].fd_seek(i,a);return c.setBigInt64(l,d,!0),f}else return p},fd_sync(r){return t.fds[r]!=null?t.fds[r].fd_sync():p},fd_tell(r,i){const a=new DataView(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const{ret:l,offset:c}=t.fds[r].fd_tell();return a.setBigUint64(i,c,!0),l}else return p},fd_write(r,i,a,l){const c=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const d=C.read_bytes_array(c,i,a);let h=0;for(const _ of d){const b=f.slice(_.buf,_.buf+_.buf_len),{ret:y,nwritten:v}=t.fds[r].fd_write(b);if(y!=m)return c.setUint32(l,h,!0),y;if(h+=v,v!=b.byteLength)break}return c.setUint32(l,h,!0),m}else return p},path_create_directory(r,i,a){const l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const c=new TextDecoder("utf-8").decode(l.slice(i,i+a));return t.fds[r].path_create_directory(c)}else return p},path_filestat_get(r,i,a,l,c){const f=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const h=new TextDecoder("utf-8").decode(d.slice(a,a+l)),{ret:_,filestat:b}=t.fds[r].path_filestat_get(i,h);return b?.write_bytes(f,c),_}else return p},path_filestat_set_times(r,i,a,l,c,f,d){const h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const _=new TextDecoder("utf-8").decode(h.slice(a,a+l));return t.fds[r].path_filestat_set_times(i,_,c,f,d)}else return p},path_link(r,i,a,l,c,f,d){const h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null&&t.fds[c]!=null){const _=new TextDecoder("utf-8").decode(h.slice(a,a+l)),b=new TextDecoder("utf-8").decode(h.slice(f,f+d)),{ret:y,inode_obj:v}=t.fds[r].path_lookup(_,i);return v==null?y:t.fds[c].path_link(b,v,!1)}else return p},path_open(r,i,a,l,c,f,d,h,_){const b=new DataView(t.inst.exports.memory.buffer),y=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const v=new TextDecoder("utf-8").decode(y.slice(a,a+l));x.log(v);const{ret:I,fd_obj:ee}=t.fds[r].path_open(i,v,c,f,d,h);if(I!=0)return I;t.fds.push(ee);const D=t.fds.length-1;return b.setUint32(_,D,!0),0}else return p},path_readlink(r,i,a,l,c,f){const d=new DataView(t.inst.exports.memory.buffer),h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const _=new TextDecoder("utf-8").decode(h.slice(i,i+a));x.log(_);const{ret:b,data:y}=t.fds[r].path_readlink(_);if(y!=null){const v=new TextEncoder().encode(y);if(v.length>c)return d.setUint32(f,0,!0),p;h.set(v,l),d.setUint32(f,v.length,!0)}return b}else return p},path_remove_directory(r,i,a){const l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const c=new TextDecoder("utf-8").decode(l.slice(i,i+a));return t.fds[r].path_remove_directory(c)}else return p},path_rename(r,i,a,l,c,f){const d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null&&t.fds[l]!=null){const h=new TextDecoder("utf-8").decode(d.slice(i,i+a)),_=new TextDecoder("utf-8").decode(d.slice(c,c+f));let{ret:b,inode_obj:y}=t.fds[r].path_unlink(h);if(y==null)return b;if(b=t.fds[l].path_link(_,y,!0),b!=m&&t.fds[r].path_link(h,y,!0)!=m)throw"path_link should always return success when relinking an inode back to the original place";return b}else return p},path_symlink(r,i,a,l,c){const f=new Uint8Array(t.inst.exports.memory.buffer);return t.fds[a]!=null?(new TextDecoder("utf-8").decode(f.slice(r,r+i)),new TextDecoder("utf-8").decode(f.slice(l,l+c)),w):p},path_unlink_file(r,i,a){const l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const c=new TextDecoder("utf-8").decode(l.slice(i,i+a));return t.fds[r].path_unlink_file(c)}else return p},poll_oneoff(r,i,a){throw"async io not supported"},proc_exit(r){throw new ce(r)},proc_raise(r){throw"raised signal "+r},sched_yield(){},random_get(r,i){const a=new Uint8Array(t.inst.exports.memory.buffer);for(let l=0;l<i;l++)a[r+l]=Math.random()*256|0},sock_recv(r,i,a){throw"sockets not supported"},sock_send(r,i,a){throw"sockets not supported"},sock_shutdown(r,i){throw"sockets not supported"},sock_accept(r,i){throw"sockets not supported"}}}};class pe{fd_allocate(e,n){return w}fd_close(){return 0}fd_fdstat_get(){return{ret:w,fdstat:null}}fd_fdstat_set_flags(e){return w}fd_fdstat_set_rights(e,n){return w}fd_filestat_get(){return{ret:w,filestat:null}}fd_filestat_set_size(e){return w}fd_filestat_set_times(e,n,s){return w}fd_pread(e,n){return{ret:w,data:new Uint8Array}}fd_prestat_get(){return{ret:w,prestat:null}}fd_pwrite(e,n){return{ret:w,nwritten:0}}fd_read(e){return{ret:w,data:new Uint8Array}}fd_readdir_single(e){return{ret:w,dirent:null}}fd_seek(e,n){return{ret:w,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:w,offset:0n}}fd_write(e){return{ret:w,nwritten:0}}path_create_directory(e){return w}path_filestat_get(e,n){return{ret:w,filestat:null}}path_filestat_set_times(e,n,s,o,t){return w}path_link(e,n,s){return w}path_unlink(e){return{ret:w,inode_obj:null}}path_lookup(e,n){return{ret:w,inode_obj:null}}path_open(e,n,s,o,t,r){return{ret:k,fd_obj:null}}path_readlink(e){return{ret:w,data:null}}path_remove_directory(e){return w}path_rename(e,n,s){return w}path_unlink_file(e){return w}}class ge{}class z extends pe{fd_allocate(e,n){if(!(this.file.size>e+n)){const s=new Uint8Array(Number(e+n));s.set(this.file.data,0),this.file.data=s}return m}fd_fdstat_get(){return{ret:0,fdstat:new be(q,0)}}fd_filestat_set_size(e){if(this.file.size>e)this.file.data=new Uint8Array(this.file.data.buffer.slice(0,Number(e)));else{const n=new Uint8Array(Number(e));n.set(this.file.data,0),this.file.data=n}return m}fd_read(e){const n=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(e)));return this.file_pos+=BigInt(n.length),{ret:0,data:n}}fd_pread(e,n){return{ret:0,data:this.file.data.slice(Number(n),Number(n+BigInt(e)))}}fd_seek(e,n){let s;switch(n){case Pe:s=e;break;case Ae:s=this.file_pos+e;break;case he:s=BigInt(this.file.data.byteLength)+e;break;default:return{ret:W,offset:0n}}return s<0?{ret:W,offset:0n}:(this.file_pos=s,{ret:0,offset:this.file_pos})}fd_tell(){return{ret:0,offset:this.file_pos}}fd_write(e){if(this.file.readonly)return{ret:p,nwritten:0};if(this.file_pos+BigInt(e.byteLength)>this.file.size){const n=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(e.byteLength))),this.file.data.set(n)}return this.file.data.set(e,Number(this.file_pos)),this.file_pos+=BigInt(e.byteLength),{ret:0,nwritten:e.byteLength}}fd_pwrite(e,n){if(this.file.readonly)return{ret:p,nwritten:0};if(n+BigInt(e.byteLength)>this.file.size){const s=this.file.data;this.file.data=new Uint8Array(Number(n+BigInt(e.byteLength))),this.file.data.set(s)}return this.file.data.set(e,Number(n)),{ret:0,nwritten:e.byteLength}}fd_filestat_get(){return{ret:0,filestat:this.file.stat()}}constructor(e){super(),this.file_pos=0n,this.file=e}}class ye extends pe{fd_seek(e,n){return{ret:p,offset:0n}}fd_tell(){return{ret:p,offset:0n}}fd_allocate(e,n){return p}fd_fdstat_get(){return{ret:0,fdstat:new be(j,0)}}fd_readdir_single(e){if(x.enabled&&(x.log("readdir_single",e),x.log(e,this.dir.contents.keys())),e==0n)return{ret:m,dirent:new Y(1n,".",j)};if(e==1n)return{ret:m,dirent:new Y(2n,"..",j)};if(e>=BigInt(this.dir.contents.size)+2n)return{ret:0,dirent:null};const[n,s]=Array.from(this.dir.contents.entries())[Number(e-2n)];return{ret:0,dirent:new Y(e+1n,n,s.stat().filetype)}}path_filestat_get(e,n){const{ret:s,path:o}=U.from(n);if(o==null)return{ret:s,filestat:null};const{ret:t,entry:r}=this.dir.get_entry_for_path(o);return r==null?{ret:t,filestat:null}:{ret:0,filestat:r.stat()}}path_lookup(e,n){const{ret:s,path:o}=U.from(e);if(o==null)return{ret:s,inode_obj:null};const{ret:t,entry:r}=this.dir.get_entry_for_path(o);return r==null?{ret:t,inode_obj:null}:{ret:m,inode_obj:r}}path_open(e,n,s,o,t,r){const{ret:i,path:a}=U.from(n);if(a==null)return{ret:i,fd_obj:null};let{ret:l,entry:c}=this.dir.get_entry_for_path(a);if(c==null){if(l!=A)return{ret:l,fd_obj:null};if((s&K)==K){const{ret:f,entry:d}=this.dir.create_entry_for_path(n,(s&V)==V);if(d==null)return{ret:f,fd_obj:null};c=d}else return{ret:A,fd_obj:null}}else if((s&le)==le)return{ret:M,fd_obj:null};return(s&V)==V&&c.stat().filetype!==j?{ret:k,fd_obj:null}:c.path_open(s,o,r)}path_create_directory(e){return this.path_open(0,e,K|V,0n,0n,0).ret}path_link(e,n,s){const{ret:o,path:t}=U.from(e);if(t==null)return o;if(t.is_dir)return A;const{ret:r,parent_entry:i,filename:a,entry:l}=this.dir.get_parent_dir_and_entry_for_path(t,!0);if(i==null||a==null)return r;if(l!=null){const c=n.stat().filetype==j,f=l.stat().filetype==j;if(c&&f)if(s&&l instanceof F){if(l.contents.size!=0)return ie}else return M;else{if(c&&!f)return k;if(!c&&f)return se;if(!(n.stat().filetype==q&&l.stat().filetype==q))return M}}return!s&&n.stat().filetype==j?Q:(i.contents.set(a,n),m)}path_unlink(e){const{ret:n,path:s}=U.from(e);if(s==null)return{ret:n,inode_obj:null};const{ret:o,parent_entry:t,filename:r,entry:i}=this.dir.get_parent_dir_and_entry_for_path(s,!0);return t==null||r==null?{ret:o,inode_obj:null}:i==null?{ret:A,inode_obj:null}:(t.contents.delete(r),{ret:m,inode_obj:i})}path_unlink_file(e){const{ret:n,path:s}=U.from(e);if(s==null)return n;const{ret:o,parent_entry:t,filename:r,entry:i}=this.dir.get_parent_dir_and_entry_for_path(s,!1);return t==null||r==null||i==null?o:i.stat().filetype===j?se:(t.contents.delete(r),m)}path_remove_directory(e){const{ret:n,path:s}=U.from(e);if(s==null)return n;const{ret:o,parent_entry:t,filename:r,entry:i}=this.dir.get_parent_dir_and_entry_for_path(s,!1);return t==null||r==null||i==null?o:!(i instanceof F)||i.stat().filetype!==j?k:i.contents.size!==0?ie:t.contents.delete(r)?m:A}fd_filestat_get(){return{ret:0,filestat:this.dir.stat()}}fd_filestat_set_size(e){return p}fd_read(e){return{ret:p,data:new Uint8Array}}fd_pread(e,n){return{ret:p,data:new Uint8Array}}fd_write(e){return{ret:p,nwritten:0}}fd_pwrite(e,n){return{ret:p,nwritten:0}}constructor(e){super(),this.dir=e}}class Le extends ye{fd_prestat_get(){return{ret:0,prestat:Z.dir(this.prestat_name)}}constructor(e,n){super(new F(n)),this.prestat_name=e}}class J extends ge{path_open(e,n,s){if(this.readonly&&(n&BigInt(oe))==BigInt(oe))return{ret:Q,fd_obj:null};if((e&ue)==ue){if(this.readonly)return{ret:Q,fd_obj:null};this.data=new Uint8Array([])}const o=new z(this);return s&Fe&&o.fd_seek(0n,he),{ret:m,fd_obj:o}}get size(){return BigInt(this.data.byteLength)}stat(){return new _e(q,this.size)}constructor(e,n){super(),this.data=new Uint8Array(e),this.readonly=!!n?.readonly}}let U=class me{static from(e){const n=new me;if(n.is_dir=e.endsWith("/"),e.startsWith("/"))return{ret:ae,path:null};if(e.includes("\0"))return{ret:W,path:null};for(const s of e.split("/"))if(!(s===""||s===".")){if(s===".."){if(n.parts.pop()==null)return{ret:ae,path:null};continue}n.parts.push(s)}return{ret:m,path:n}}to_path_string(){let e=this.parts.join("/");return this.is_dir&&(e+="/"),e}constructor(){this.parts=[],this.is_dir=!1}};class F extends ge{path_open(e,n,s){return{ret:m,fd_obj:new ye(this)}}stat(){return new _e(j,0n)}get_entry_for_path(e){let n=this;for(const s of e.parts){if(!(n instanceof F))return{ret:k,entry:null};const o=n.contents.get(s);if(o!==void 0)n=o;else return x.log(s),{ret:A,entry:null}}return e.is_dir&&n.stat().filetype!=j?{ret:k,entry:null}:{ret:m,entry:n}}get_parent_dir_and_entry_for_path(e,n){const s=e.parts.pop();if(s===void 0)return{ret:W,parent_entry:null,filename:null,entry:null};const{ret:o,entry:t}=this.get_entry_for_path(e);if(t==null)return{ret:o,parent_entry:null,filename:null,entry:null};if(!(t instanceof F))return{ret:k,parent_entry:null,filename:null,entry:null};const r=t.contents.get(s);return r===void 0?n?{ret:m,parent_entry:t,filename:s,entry:null}:{ret:A,parent_entry:null,filename:null,entry:null}:e.is_dir&&r.stat().filetype!=j?{ret:k,parent_entry:null,filename:null,entry:null}:{ret:m,parent_entry:t,filename:s,entry:r}}create_entry_for_path(e,n){const{ret:s,path:o}=U.from(e);if(o==null)return{ret:s,entry:null};let{ret:t,parent_entry:r,filename:i,entry:a}=this.get_parent_dir_and_entry_for_path(o,!0);if(r==null||i==null)return{ret:t,entry:null};if(a!=null)return{ret:M,entry:null};x.log("create",o);let l;return n?l=new F(new Map):l=new J(new ArrayBuffer(0)),r.contents.set(i,l),a=l,{ret:m,entry:a}}constructor(e){super(),e instanceof Array?this.contents=new Map(e):this.contents=e}}function Ce({stdout:u,stderr:e}={stdout:console.log,stderr:console.warn}){let n,s;function o(){if(typeof n>"u")throw new Error("Memory is not set");return(s===void 0||s.buffer.byteLength===0)&&(s=new DataView(n.buffer)),s}const t=new TextDecoder;return{addToImports(r){const i=r.wasi_snapshot_preview1,a=i.fd_write;i.fd_write=(f,d,h,_)=>{if(f!==1&&f!==2)return a(f,d,h,_);const b=o(),y=Array.from({length:h},(D,Ie)=>{const te=d+Ie*8,Ue=b.getUint32(te,!0),Te=b.getUint32(te+4,!0);return new Uint8Array(n.buffer,Ue,Te)});let v=0,I="";for(const D of y)I+=t.decode(D),v+=D.byteLength;return b.setUint32(_,v,!0),(f===1?u:e)(I),0};const l=i.fd_filestat_get;i.fd_filestat_get=(f,d)=>{if(f!==1&&f!==2)return l(f,d);const h=o(),_=l(f,d);if(_!==0)return _;const b=d+0;return h.setUint8(b,2),0};const c=i.fd_fdstat_get;i.fd_fdstat_get=(f,d)=>{if(f!==1&&f!==2)return c(f,d);const h=o(),_=d+0;h.setUint8(_,2);const b=d+8;return h.setBigUint64(b,BigInt(64),!0),0}},setMemory(r){n=r}}}let X=new DataView(new ArrayBuffer);function g(u){return X.buffer!==u.buffer&&(X=new DataView(u.buffer)),X}function Me(u){return u>>>0}const T=new TextDecoder("utf-8"),ze=new TextEncoder("utf-8");function S(u,e,n){if(typeof u!="string")throw new TypeError("expected a string");if(u.length===0)return P=0,1;let s=0,o=0,t=0;for(;u.length>0;){o=e(o,s,1,s+u.length),s+=u.length;const{read:r,written:i}=ze.encodeInto(u,new Uint8Array(n.buffer,o+t,s-t));t+=i,u=u.slice(r)}return s>t&&(o=e(o,s,1,t)),P=t,o}let P=0;class we{constructor(){this.list=[],this.head=0}insert(e){this.head>=this.list.length&&this.list.push({next:this.list.length+1,val:void 0});const n=this.head,s=this.list[n];return this.head=s.next,s.next=-1,s.val=e,n}get(e){if(e>=this.list.length)throw new RangeError("handle index not valid");const n=this.list[e];if(n.next===-1)return n.val;throw new RangeError("handle index not valid")}remove(e){const n=this.get(e),s=this.list[e];return s.val=void 0,s.next=this.head,this.head=e,n}}function G(){throw new RangeError("invalid variant discriminant for bool")}class ve{constructor(){this._resource0_slab=new we}addToImports(e){"canonical_abi"in e||(e.canonical_abi={}),e.canonical_abi["resource_drop_rb-abi-value"]=n=>{this._resource0_slab.remove(n).drop()},e.canonical_abi["resource_clone_rb-abi-value"]=n=>{const s=this._resource0_slab.get(n);return this._resource0_slab.insert(s.clone())},e.canonical_abi["resource_get_rb-abi-value"]=n=>this._resource0_slab.get(n)._wasm_val,e.canonical_abi["resource_new_rb-abi-value"]=n=>(this._registry0,this._resource0_slab.insert(new N(n,this)))}async instantiate(e,n){if(n=n||{},this.addToImports(n),e instanceof WebAssembly.Instance)this.instance=e;else if(e instanceof WebAssembly.Module)this.instance=await WebAssembly.instantiate(e,n);else if(e instanceof ArrayBuffer||e instanceof Uint8Array){const{instance:s}=await WebAssembly.instantiate(e,n);this.instance=s}else{const{instance:s}=await WebAssembly.instantiateStreaming(e,n);this.instance=s}this._exports=this.instance.exports,this._registry0=new FinalizationRegistry(this._exports["canonical_abi_drop_rb-abi-value"])}rubyShowVersion(){this._exports["ruby-show-version: func() -> ()"]()}rubyInit(e){const n=this._exports.memory,s=this._exports.cabi_realloc,o=e,t=o.length,r=s(0,0,4,t*8);for(let i=0;i<o.length;i++){const a=o[i],l=r+i*8,c=S(a,s,n),f=P;g(n).setInt32(l+4,f,!0),g(n).setInt32(l+0,c,!0)}this._exports["ruby-init: func(args: list<string>) -> ()"](r,t)}rubyInitLoadpath(){this._exports["ruby-init-loadpath: func() -> ()"]()}rbEvalStringProtect(e){const n=this._exports.memory,s=this._exports.cabi_realloc,o=S(e,s,n),t=P,r=this._exports["rb-eval-string-protect: func(str: string) -> tuple<handle<rb-abi-value>, s32>"](o,t);return[this._resource0_slab.remove(g(n).getInt32(r+0,!0)),g(n).getInt32(r+4,!0)]}rbFuncallvProtect(e,n,s){const o=this._exports.memory,t=this._exports.cabi_realloc,r=e;if(!(r instanceof N))throw new TypeError("expected instance of RbAbiValue");const i=s,a=i.length,l=t(0,0,4,a*4);for(let f=0;f<i.length;f++){const d=i[f],h=l+f*4,_=d;if(!(_ instanceof N))throw new TypeError("expected instance of RbAbiValue");g(o).setInt32(h+0,this._resource0_slab.insert(_.clone()),!0)}const c=this._exports["rb-funcallv-protect: func(recv: handle<rb-abi-value>, mid: u32, args: list<handle<rb-abi-value>>) -> tuple<handle<rb-abi-value>, s32>"](this._resource0_slab.insert(r.clone()),Me(n),l,a);return[this._resource0_slab.remove(g(o).getInt32(c+0,!0)),g(o).getInt32(c+4,!0)]}rbIntern(e){const n=this._exports.memory,s=this._exports.cabi_realloc,o=S(e,s,n),t=P;return this._exports["rb-intern: func(name: string) -> u32"](o,t)>>>0}rbErrinfo(){const e=this._exports["rb-errinfo: func() -> handle<rb-abi-value>"]();return this._resource0_slab.remove(e)}rbClearErrinfo(){this._exports["rb-clear-errinfo: func() -> ()"]()}rstringPtr(e){const n=this._exports.memory,s=e;if(!(s instanceof N))throw new TypeError("expected instance of RbAbiValue");const o=this._exports["rstring-ptr: func(value: handle<rb-abi-value>) -> string"](this._resource0_slab.insert(s.clone())),t=g(n).getInt32(o+0,!0),r=g(n).getInt32(o+4,!0),i=T.decode(new Uint8Array(n.buffer,t,r));return this._exports["cabi_post_rstring-ptr"](o),i}rbVmBugreport(){this._exports["rb-vm-bugreport: func() -> ()"]()}rbGcEnable(){const n=this._exports["rb-gc-enable: func() -> bool"]();return n==0?!1:n==1?!0:G()}rbGcDisable(){const n=this._exports["rb-gc-disable: func() -> bool"]();return n==0?!1:n==1?!0:G()}rbSetShouldProhibitRewind(e){const s=this._exports["rb-set-should-prohibit-rewind: func(new-value: bool) -> bool"](e?1:0);return s==0?!1:s==1?!0:G()}}class N{constructor(e,n){this._wasm_val=e,this._obj=n,this._refcnt=1,n._registry0.register(this,e,this)}clone(){return this._refcnt+=1,this}drop(){if(this._refcnt-=1,this._refcnt!==0)return;this._obj._registry0.unregister(this);const e=this._obj._exports["canonical_abi_drop_rb-abi-value"],n=this._wasm_val;delete this._obj,delete this._refcnt,delete this._wasm_val,e(n)}}function Je(u,e,n){"rb-js-abi-host"in u||(u["rb-js-abi-host"]={}),u["rb-js-abi-host"]["eval-js: func(code: string) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(o,t,r){const i=n("memory"),a=o,l=t,c=T.decode(new Uint8Array(i.buffer,a,l)),d=e.evalJs(c);switch(d.tag){case"success":{const h=d.val;g(i).setInt8(r+0,0,!0),g(i).setInt32(r+4,s.insert(h),!0);break}case"failure":{const h=d.val;g(i).setInt8(r+0,1,!0),g(i).setInt32(r+4,s.insert(h),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},u["rb-js-abi-host"]["is-js: func(value: handle<js-abi-value>) -> bool"]=function(o){return e.isJs(s.get(o))?1:0},u["rb-js-abi-host"]["instance-of: func(value: handle<js-abi-value>, klass: handle<js-abi-value>) -> bool"]=function(o,t){return e.instanceOf(s.get(o),s.get(t))?1:0},u["rb-js-abi-host"]["global-this: func() -> handle<js-abi-value>"]=function(){const o=e.globalThis();return s.insert(o)},u["rb-js-abi-host"]["int-to-js-number: func(value: s32) -> handle<js-abi-value>"]=function(o){const t=e.intToJsNumber(o);return s.insert(t)},u["rb-js-abi-host"]["float-to-js-number: func(value: float64) -> handle<js-abi-value>"]=function(o){const t=e.floatToJsNumber(o);return s.insert(t)},u["rb-js-abi-host"]["string-to-js-string: func(value: string) -> handle<js-abi-value>"]=function(o,t){const r=n("memory"),i=o,a=t,l=T.decode(new Uint8Array(r.buffer,i,a)),c=e.stringToJsString(l);return s.insert(c)},u["rb-js-abi-host"]["bool-to-js-bool: func(value: bool) -> handle<js-abi-value>"]=function(o){const t=o,r=e.boolToJsBool(t==0?!1:t==1?!0:G());return s.insert(r)},u["rb-js-abi-host"]["proc-to-js-function: func(value: u32) -> handle<js-abi-value>"]=function(o){const t=e.procToJsFunction(o>>>0);return s.insert(t)},u["rb-js-abi-host"]["rb-object-to-js-rb-value: func(raw-rb-abi-value: u32) -> handle<js-abi-value>"]=function(o){const t=e.rbObjectToJsRbValue(o>>>0);return s.insert(t)},u["rb-js-abi-host"]["js-value-to-string: func(value: handle<js-abi-value>) -> string"]=function(o,t){const r=n("memory"),i=n("cabi_realloc"),a=e.jsValueToString(s.get(o)),l=S(a,i,r),c=P;g(r).setInt32(t+4,c,!0),g(r).setInt32(t+0,l,!0)},u["rb-js-abi-host"]["js-value-to-integer: func(value: handle<js-abi-value>) -> variant { as-float(float64), bignum(string) }"]=function(o,t){const r=n("memory"),i=n("cabi_realloc"),l=e.jsValueToInteger(s.get(o));switch(l.tag){case"as-float":{const c=l.val;g(r).setInt8(t+0,0,!0),g(r).setFloat64(t+8,+c,!0);break}case"bignum":{const c=l.val;g(r).setInt8(t+0,1,!0);const f=S(c,i,r),d=P;g(r).setInt32(t+12,d,!0),g(r).setInt32(t+8,f,!0);break}default:throw new RangeError("invalid variant specified for RawInteger")}},u["rb-js-abi-host"]["export-js-value-to-host: func(value: handle<js-abi-value>) -> ()"]=function(o){e.exportJsValueToHost(s.get(o))},u["rb-js-abi-host"]["import-js-value-from-host: func() -> handle<js-abi-value>"]=function(){const o=e.importJsValueFromHost();return s.insert(o)},u["rb-js-abi-host"]["js-value-typeof: func(value: handle<js-abi-value>) -> string"]=function(o,t){const r=n("memory"),i=n("cabi_realloc"),a=e.jsValueTypeof(s.get(o)),l=S(a,i,r),c=P;g(r).setInt32(t+4,c,!0),g(r).setInt32(t+0,l,!0)},u["rb-js-abi-host"]["js-value-equal: func(lhs: handle<js-abi-value>, rhs: handle<js-abi-value>) -> bool"]=function(o,t){return e.jsValueEqual(s.get(o),s.get(t))?1:0},u["rb-js-abi-host"]["js-value-strictly-equal: func(lhs: handle<js-abi-value>, rhs: handle<js-abi-value>) -> bool"]=function(o,t){return e.jsValueStrictlyEqual(s.get(o),s.get(t))?1:0},u["rb-js-abi-host"]["reflect-apply: func(target: handle<js-abi-value>, this-argument: handle<js-abi-value>, arguments: list<handle<js-abi-value>>) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(o,t,r,i,a){const l=n("memory"),c=i,f=r,d=[];for(let b=0;b<c;b++){const y=f+b*4;d.push(s.get(g(l).getInt32(y+0,!0)))}const _=e.reflectApply(s.get(o),s.get(t),d);switch(_.tag){case"success":{const b=_.val;g(l).setInt8(a+0,0,!0),g(l).setInt32(a+4,s.insert(b),!0);break}case"failure":{const b=_.val;g(l).setInt8(a+0,1,!0),g(l).setInt32(a+4,s.insert(b),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},u["rb-js-abi-host"]["reflect-construct: func(target: handle<js-abi-value>, arguments: list<handle<js-abi-value>>) -> handle<js-abi-value>"]=function(o,t,r){const i=n("memory"),a=r,l=t,c=[];for(let d=0;d<a;d++){const h=l+d*4;c.push(s.get(g(i).getInt32(h+0,!0)))}const f=e.reflectConstruct(s.get(o),c);return s.insert(f)},u["rb-js-abi-host"]["reflect-delete-property: func(target: handle<js-abi-value>, property-key: string) -> bool"]=function(o,t,r){const i=n("memory"),a=t,l=r,c=T.decode(new Uint8Array(i.buffer,a,l));return e.reflectDeleteProperty(s.get(o),c)?1:0},u["rb-js-abi-host"]["reflect-get: func(target: handle<js-abi-value>, property-key: string) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(o,t,r,i){const a=n("memory"),l=t,c=r,f=T.decode(new Uint8Array(a.buffer,l,c)),h=e.reflectGet(s.get(o),f);switch(h.tag){case"success":{const _=h.val;g(a).setInt8(i+0,0,!0),g(a).setInt32(i+4,s.insert(_),!0);break}case"failure":{const _=h.val;g(a).setInt8(i+0,1,!0),g(a).setInt32(i+4,s.insert(_),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},u["rb-js-abi-host"]["reflect-get-own-property-descriptor: func(target: handle<js-abi-value>, property-key: string) -> handle<js-abi-value>"]=function(o,t,r){const i=n("memory"),a=t,l=r,c=T.decode(new Uint8Array(i.buffer,a,l)),f=e.reflectGetOwnPropertyDescriptor(s.get(o),c);return s.insert(f)},u["rb-js-abi-host"]["reflect-get-prototype-of: func(target: handle<js-abi-value>) -> handle<js-abi-value>"]=function(o){const t=e.reflectGetPrototypeOf(s.get(o));return s.insert(t)},u["rb-js-abi-host"]["reflect-has: func(target: handle<js-abi-value>, property-key: string) -> bool"]=function(o,t,r){const i=n("memory"),a=t,l=r,c=T.decode(new Uint8Array(i.buffer,a,l));return e.reflectHas(s.get(o),c)?1:0},u["rb-js-abi-host"]["reflect-is-extensible: func(target: handle<js-abi-value>) -> bool"]=function(o){return e.reflectIsExtensible(s.get(o))?1:0},u["rb-js-abi-host"]["reflect-own-keys: func(target: handle<js-abi-value>) -> list<handle<js-abi-value>>"]=function(o,t){const r=n("memory"),i=n("cabi_realloc"),l=e.reflectOwnKeys(s.get(o)),c=l.length,f=i(0,0,4,c*4);for(let d=0;d<l.length;d++){const h=l[d],_=f+d*4;g(r).setInt32(_+0,s.insert(h),!0)}g(r).setInt32(t+4,c,!0),g(r).setInt32(t+0,f,!0)},u["rb-js-abi-host"]["reflect-prevent-extensions: func(target: handle<js-abi-value>) -> bool"]=function(o){return e.reflectPreventExtensions(s.get(o))?1:0},u["rb-js-abi-host"]["reflect-set: func(target: handle<js-abi-value>, property-key: string, value: handle<js-abi-value>) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(o,t,r,i,a){const l=n("memory"),c=t,f=r,d=T.decode(new Uint8Array(l.buffer,c,f)),_=e.reflectSet(s.get(o),d,s.get(i));switch(_.tag){case"success":{const b=_.val;g(l).setInt8(a+0,0,!0),g(l).setInt32(a+4,s.insert(b),!0);break}case"failure":{const b=_.val;g(l).setInt8(a+0,1,!0),g(l).setInt32(a+4,s.insert(b),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},u["rb-js-abi-host"]["reflect-set-prototype-of: func(target: handle<js-abi-value>, prototype: handle<js-abi-value>) -> bool"]=function(o,t){return e.reflectSetPrototypeOf(s.get(o),s.get(t))?1:0},"canonical_abi"in u||(u.canonical_abi={});const s=new we;u.canonical_abi["resource_drop_js-abi-value"]=o=>{const t=s.remove(o);e.dropJsAbiValue&&e.dropJsAbiValue(t)}}class Ge extends ve{async setInstance(e){await this.instantiate(e)}}class $e{constructor(){}setUnderlying(e){this.underlying=e}rubyShowVersion(){this.underlying.rubyShowVersion()}rubyInit(e){this.underlying.rubyInit(e)}rubyInitLoadpath(){this.underlying.rubyInitLoadpath()}rbEvalStringProtect(e){return this.underlying.rbEvalStringProtect(e)}rbFuncallvProtect(e,n,s){return this.underlying.rbFuncallvProtect(e,n,s)}rbIntern(e){return this.underlying.rbIntern(e)}rbErrinfo(){return this.underlying.rbErrinfo()}rbClearErrinfo(){return this.underlying.rbClearErrinfo()}rstringPtr(e){return this.underlying.rstringPtr(e)}rbVmBugreport(){this.underlying.rbVmBugreport()}rbGcEnable(){return this.underlying.rbGcEnable()}rbGcDisable(){return this.underlying.rbGcDisable()}rbSetShouldProhibitRewind(e){return this.underlying.rbSetShouldProhibitRewind(e)}async setInstance(e){}addToImports(e){}}class H{static async instantiateModule(e){var n,s;const{module:o,wasip1:t}=e,r=new H,i={wasi_snapshot_preview1:t.wasiImport};r.addToImports(i),(n=e.addToImports)===null||n===void 0||n.call(e,i);const a=await WebAssembly.instantiate(o,i);try{await r.setInstance(a)}catch(l){throw console.error('Failed to instantiate Ruby VM. Please make sure that you have added `gem "js"` to your Gemfile.'),l}return(s=e.setMemory)===null||s===void 0||s.call(e,a.exports.memory),t.initialize(a),r.initialize(e.args),{vm:r,instance:a}}static async instantiateComponent(e){let n;return"getCoreModule"in e?n=async o=>{const{instantiate:t,getCoreModule:r,wasip2:i}=e,{cli:a,clocks:l,filesystem:c,io:f,random:d,sockets:h,http:_}=i,b={"ruby:js/js-runtime":o,"wasi:cli/environment":a.environment,"wasi:cli/exit":a.exit,"wasi:cli/stderr":a.stderr,"wasi:cli/stdin":a.stdin,"wasi:cli/stdout":a.stdout,"wasi:cli/terminal-input":a.terminalInput,"wasi:cli/terminal-output":a.terminalOutput,"wasi:cli/terminal-stderr":a.terminalStderr,"wasi:cli/terminal-stdin":a.terminalStdin,"wasi:cli/terminal-stdout":a.terminalStdout,"wasi:clocks/monotonic-clock":l.monotonicClock,"wasi:clocks/wall-clock":l.wallClock,"wasi:filesystem/preopens":c.preopens,"wasi:filesystem/types":c.types,"wasi:io/error":f.error,"wasi:io/poll":f.poll,"wasi:io/streams":f.streams,"wasi:random/random":d.random,"wasi:sockets/tcp":h.tcp,"wasi:http/types":_.types,"wasi:http/incoming-handler":_.incomingHandler,"wasi:http/outgoing-handler":_.outgoingHandler};return(await t(r,b,e.instantiateCore)).rubyRuntime}:n=e.instantiate,{vm:await this._instantiate({},n)}}constructor(e){this.instance=null,this.interfaceState={hasJSFrameAfterRbFrame:!1};const n=s=>{const o=["setInstance","addToImports","instantiate","rbSetShouldProhibitRewind","rbGcDisable","rbGcEnable"],t=["constructor"].concat(o);for(const r of Object.getOwnPropertyNames(ve.prototype)){if(t.includes(r))continue;const i=s[r];typeof i=="function"&&(s[r]=(...a)=>{if(this.interfaceState.hasJSFrameAfterRbFrame){const c=this.guest.rbSetShouldProhibitRewind(!0),f=this.guest.rbGcDisable(),d=Reflect.apply(i,s,a);return this.guest.rbSetShouldProhibitRewind(c),f||this.guest.rbGcEnable(),d}else return Reflect.apply(i,s,a)})}return s};this.guest=n(e??new Ge),this.transport=new We,this.exceptionFormatter=new qe}static async _instantiate(e,n){const s=new $e,o=new H(s);class t{constructor(l){this.underlying=l}}const r=o.getImports(a=>new t(a),a=>a.underlying),i=await n(Object.assign(Object.assign({},r),{throwProhibitRewindException:a=>{o.throwProhibitRewindException(a)},procToJsFunction:()=>{const a=new O(i.exportRbValueToJs(),o,o.privateObject());return new t((...l)=>a.call("call",...l.map(c=>o.wrap(c))).toJS())},rbObjectToJsRbValue:()=>{const a=new O(i.exportRbValueToJs(),o,o.privateObject());return new t(a)},JsAbiValue:t}));return s.setUnderlying(i),o.initialize(e.args),o}initialize(e=["ruby.wasm","-EUTF-8","-e_=0"]){const n=e.map(s=>s+"\0");this.guest.rubyInit(n);try{this.eval(`
        # Require Bundler standalone setup
        if File.exist?("/bundle/bundler/setup.rb")
          require "/bundle/bundler/setup.rb"
        elsif File.exist?("/bundle/setup.rb")
          # For non-CM builds, which doesn't use Bundler's standalone mode
          require "/bundle/setup.rb"
        end
      `)}catch(s){console.warn("Failed to load /bundle/setup",s)}}async setInstance(e){this.instance=e,await this.guest.setInstance(e)}addToImports(e){this.guest.addToImports(e),e["rb-js-abi-host"]={rb_wasm_throw_prohibit_rewind_exception:(n,s)=>{const o=this.instance.exports.memory,t=new TextDecoder().decode(new Uint8Array(o.buffer,n,s));this.throwProhibitRewindException(t)}},Je(e,this.getImports(n=>n,n=>n),n=>this.instance.exports[n])}throwProhibitRewindException(e){let n=`Ruby APIs that may rewind the VM stack are prohibited under nested VM operation (${e})
Nested VM operation means that the call stack has sandwitched JS frames like JS -> Ruby -> JS -> Ruby caused by something like \`window.rubyVM.eval("JS.global[:rubyVM].eval('Fiber.yield')")\`

Please check your call stack and make sure that you are **not** doing any of the following inside the nested Ruby frame:
  1. Switching fibers (e.g. Fiber#resume, Fiber.yield, and Fiber#transfer)
     Note that \`evalAsync\` JS API switches fibers internally
  2. Raising uncaught exceptions
     Please catch all exceptions inside the nested operation
  3. Calling Continuation APIs
`;const s=new O(this.guest.rbErrinfo(),this,this.privateObject());throw s.call("nil?").toString()==="false"&&(n+=`
`+this.exceptionFormatter.format(s,this,this.privateObject())),new de(n)}getImports(e,n){const s=t=>{for(const[r,i]of Object.entries(t))typeof i=="function"&&(t[r]=(...a)=>{const l=this.interfaceState.hasJSFrameAfterRbFrame;this.interfaceState.hasJSFrameAfterRbFrame=!0;const c=Reflect.apply(i,t,a);return this.interfaceState.hasJSFrameAfterRbFrame=l,c});return t};function o(t){return(...r)=>{try{return{tag:"success",val:t(...r)}}catch(i){if(i instanceof de)throw i;return{tag:"failure",val:e(i)}}}}return s({evalJs:o(t=>e(Function(t)())),isJs:t=>!0,globalThis:()=>{if(typeof globalThis<"u")return e(globalThis);if(typeof global<"u")return e(global);if(typeof window<"u")return e(window);throw new Error("unable to locate global object")},intToJsNumber:t=>e(t),floatToJsNumber:t=>e(t),stringToJsString:t=>e(t),boolToJsBool:t=>e(t),procToJsFunction:t=>{const r=this.rbValueOfPointer(t);return e((...i)=>r.call("call",...i.map(a=>this.wrap(a))).toJS())},rbObjectToJsRbValue:t=>e(this.rbValueOfPointer(t)),jsValueToString:t=>(t=n(t),String(t)),jsValueToInteger(t){return t=n(t),typeof t=="number"?{tag:"as-float",val:t}:typeof t=="bigint"?{tag:"bignum",val:BigInt(t).toString(10)+"\0"}:typeof t=="string"?{tag:"bignum",val:t+"\0"}:typeof t>"u"?{tag:"as-float",val:0}:{tag:"as-float",val:Number(t)}},exportJsValueToHost:t=>{this.transport.takeJsValue(n(t))},importJsValueFromHost:()=>e(this.transport.consumeJsValue()),instanceOf:(t,r)=>(r=n(r),typeof r=="function"?n(t)instanceof r:!1),jsValueTypeof(t){return typeof n(t)},jsValueEqual(t,r){return n(t)==n(r)},jsValueStrictlyEqual(t,r){return n(t)===n(r)},reflectApply:o((t,r,i)=>{const a=i.map(l=>n(l));return e(Reflect.apply(n(t),n(r),a))}),reflectConstruct:function(t,r){throw new Error("Function not implemented.")},reflectDeleteProperty:function(t,r){throw new Error("Function not implemented.")},reflectGet:o((t,r)=>e(n(t)[r])),reflectGetOwnPropertyDescriptor:function(t,r){throw new Error("Function not implemented.")},reflectGetPrototypeOf:function(t){throw new Error("Function not implemented.")},reflectHas:function(t,r){throw new Error("Function not implemented.")},reflectIsExtensible:function(t){throw new Error("Function not implemented.")},reflectOwnKeys:function(t){throw new Error("Function not implemented.")},reflectPreventExtensions:function(t){throw new Error("Function not implemented.")},reflectSet:o((t,r,i)=>e(Reflect.set(n(t),r,n(i)))),reflectSetPrototypeOf:function(t,r){throw new Error("Function not implemented.")}})}printVersion(){this.guest.rubyShowVersion()}eval(e){return $(this,this.privateObject(),e)}evalAsync(e){const n=this.eval("require 'js'; JS");return Re(this,this.privateObject(),s=>{n.call("__eval_async_rb",this.wrap(e),s)})}wrap(e){return this.transport.importJsValue(e,this)}privateObject(){return{transport:this.transport,exceptionFormatter:this.exceptionFormatter}}rbValueOfPointer(e){const n=new N(e,this.guest);return new O(n,this,this.privateObject())}}class We{constructor(){this._takenJsValue=null}takeJsValue(e){this._takenJsValue=e}consumeJsValue(){return this._takenJsValue}exportJsValue(e){return e.call("__export_to_js"),this._takenJsValue}importJsValue(e,n){return this._takenJsValue=e,n.eval('require "js"; JS::Object').call("__import_from_js")}}class O{constructor(e,n,s){this.inner=e,this.vm=n,this.privateObject=s}call(e,...n){const s=n.map(o=>o.inner);return new O(fe(this.vm,this.privateObject,this.inner,e,s),this.vm,this.privateObject)}callAsync(e,...n){const s=this.vm.eval("require 'js'; JS");return Re(this.vm,this.privateObject,o=>{s.call("__call_async_method",this,this.vm.wrap(e),o,...n)})}[Symbol.toPrimitive](e){return e==="string"||e==="default"?this.toString():null}toString(){const e=fe(this.vm,this.privateObject,this.inner,"to_s",[]);return this.vm.guest.rstringPtr(e)}toJS(){const n=this.vm.eval("JS").call("try_convert",this);return n.call("nil?").toString()==="true"?null:this.privateObject.transport.exportJsValue(n)}}var R;(function(u){u[u.None=0]="None",u[u.Return=1]="Return",u[u.Break=2]="Break",u[u.Next=3]="Next",u[u.Retry=4]="Retry",u[u.Redo=5]="Redo",u[u.Raise=6]="Raise",u[u.Throw=7]="Throw",u[u.Fatal=8]="Fatal",u[u.Mask=15]="Mask"})(R||(R={}));class qe{constructor(){this.literalsCache=null,this.isFormmatting=!1}format(e,n,s){class o extends Error{}if(this.isFormmatting)throw new o("Unexpected exception occurred during formatting exception message");this.isFormmatting=!0;try{return this._format(e,n,s)}finally{this.isFormmatting=!1}}_format(e,n,s){const[o,t,r]=(()=>{if(this.literalsCache==null){const c=[$(n,s,"0"),$(n,s,"1"),$(n,s,`"
"`)];return this.literalsCache=c,c}else return this.literalsCache})();let i,a,l;try{i=e.call("class").toString()}catch{i="unknown"}try{l=e.call("message").toString()}catch{l="unknown"}try{a=e.call("backtrace")}catch{return this.formatString(i,l)}if(a.call("nil?").toString()==="true")return this.formatString(i,l);try{const c=a.call("at",o),f=a.call("drop",t).call("join",r);return this.formatString(i,l,[c.toString(),f.toString()])}catch{return this.formatString(i,l)}}formatString(e,n,s){return s?`${s[0]}: ${n} (${e})
${s[1]}`:`${e}: ${n}`}}const xe=(u,e,n)=>{switch(u&R.Mask){case R.None:break;case R.Return:throw new E("unexpected return");case R.Next:throw new E("unexpected next");case R.Break:throw new E("unexpected break");case R.Redo:throw new E("unexpected redo");case R.Retry:throw new E("retry outside of rescue clause");case R.Throw:throw new E("unexpected throw");case R.Raise:case R.Fatal:const s=new O(e.guest.rbErrinfo(),e,n);throw s.call("nil?").toString()==="true"?new E("no exception object"):(e.guest.rbClearErrinfo(),new E(n.exceptionFormatter.format(s,e,n)));default:throw new E(`unknown error tag: ${u}`)}};function Ee(u,e){try{return e()}catch(n){if(n instanceof E)throw n;try{u.guest.rbVmBugreport()}catch(s){console.error("Tried to report internal Ruby VM state but failed: ",s)}if(n instanceof WebAssembly.RuntimeError&&n.message==="unreachable"){const s=new E(`Something went wrong in Ruby VM: ${n}`);throw s.stack=n.stack,s}else throw n}}const fe=(u,e,n,s,o)=>{const t=u.guest.rbIntern(s+"\0");return Ee(u,()=>{const[r,i]=u.guest.rbFuncallvProtect(n,t,o);return xe(i,u,e),r})},$=(u,e,n)=>Ee(u,()=>{const[s,o]=u.guest.rbEvalStringProtect(n+"\0");return xe(o,u,e),new O(s,u,e)});function Re(u,e,n){return new Promise((s,o)=>{const t=u.wrap({resolve:s,reject:r=>{const i=new E(e.exceptionFormatter.format(r,u,e));o(i)}});n(t)})}class E extends Error{constructor(e){super(e)}}class de extends E{constructor(e){super("Ruby Fatal Error: "+e)}}const He=async(u,e={})=>{var n,s;const o=[],t=Object.entries((n=e.env)!==null&&n!==void 0?n:{}).map(([f,d])=>`${f}=${d}`),r=[new z(new J([])),new z(new J([])),new z(new J([])),new Le("/",new Map)],i=new Be(o,t,r,{debug:!1}),a=!((s=e.consolePrint)!==null&&s!==void 0)||s?Ce():void 0,{vm:l,instance:c}=await H.instantiateModule({module:u,wasip1:i,addToImports:f=>{a?.addToImports(f)},setMemory:f=>{a?.setMemory(f)}});return{vm:l,wasi:i,instance:c}},Ye=`# Pesca Module
# This module is automatically loaded in the Ruby WASM REPL

module Pesca
  VERSION = "0.1.0"

  def self.greet(name = "World")
    "Hello, \${name}! Welcome to Pesca!"
  end

  def self.info
    puts "Pesca Ruby REPL v\${VERSION}"
    puts "Ruby version: \${RUBY_VERSION}"
    puts "Platform: \${RUBY_PLATFORM}"
  end

  class Partecipanti
    attr_accessor :names

    def initialize
      @partecipanti = []
    end

    def reset!
      @partecipanti = []
    end

    def aggiungi(name, bloccati: "")
      @partecipanti << Partecipante.new(name, bloccati: bloccati.split(",").map(&:strip))
    end

    def lista
      @partecipanti.map(&:inspect)
    end

    def each(&block)
      @partecipanti.each(&block)
    end

    def sample
      @partecipanti.sample
    end

    def size
      @partecipanti.size
    end
  end

  class Partecipante
    attr_reader :name

    def initialize(name, bloccati: [])
      @name = name
      @assegnato = nil
      @bloccati = bloccati
      @assegnato_a_qualcuno = false
    end

    def assegna_destinatario(partecipante)
      return false if partecipante.assegnato_a_qualcuno?
      return false if partecipante == self
      @destinatario = partecipante
      @destinatario.assegnato_a_qualcuno!
      true
    end

    def assegnato_a_qualcuno!
      @assegnato_a_qualcuno = true
    end

    def assegnato_a_qualcuno?
      @assegnato_a_qualcuno
    end

    def inspect
      "\${@name} -> \${@destinatario ? @destinatario.name : 'Nessuno'}"
    end

    def valid?
      @destinatario && !@bloccati.include?(@destinatario.name)
    end
  end

  def self.reset!
    @partecipanti = nil
  end

  def self.imposta_partecipanti(&block)
    @partecipanti ||= Partecipanti.new

    @partecipanti.instance_exec(&block)
  end

  def self.lista_partecipanti
    @partecipanti ? @partecipanti.lista : []
  end

  def self.assegna!
    @partecipanti.each do
      i = 0
      until it.valid?
        i += 1
        puts "Assegnando per \${it.name} ..."
        it.assegna_destinatario(@partecipanti.sample)
        raise("Oh no, piÃ¹ di \${@partecipanti.size * 100} tentativi: sono stanco! Devi di nuovo mettere i bigliettini nel cappello.") if i > @partecipanti.size * 100
      end
    end
  rescue => e
    puts "Errore durante l'assegnazione: \${e.message}"
  end
end

# Make it easier to access
include Pesca

puts "Pesca module loaded successfully!"
`;let B=null;async function Ke(){const e=await(await fetch("https://cdn.jsdelivr.net/npm/@ruby/3.4-wasm-wasi@2.7.2/dist/ruby+stdlib.wasm")).arrayBuffer(),n=await WebAssembly.compile(e),{vm:s}=await He(n);B=s,B.eval(Ye),console.log("Ruby VM initialized with Pesca module loaded"),document.getElementById("output").textContent=`Ready! Ruby VM initialized with Pesca module loaded.
`}function je(){const u=document.getElementById("editor").value,e=document.getElementById("output");if(console.log("Execute button clicked"),console.log("Code:",u),console.log("rubyVM:",B),!B){e.textContent="Error: Ruby VM not initialized yet. Please wait...";return}try{const n=B.eval(`
      require 'stringio'
      $captured_output = StringIO.new
      old_stdout = $stdout
      $stdout = $captured_output

      begin
        result = eval(<<-'RUBY_CODE'
${u}
RUBY_CODE
        )
        $stdout = old_stdout
        output = $captured_output.string
        output += "=> " + result.inspect if !result.nil?
        output
      rescue => e
        $stdout = old_stdout
        "Error: " + e.class.to_s + ": " + e.message + "\\n" + e.backtrace.join("\\n")
      end
    `);console.log("Result:",n),e.textContent=n.toString()}catch(n){e.textContent=`Error: ${n.message}`,console.error("Error executing:",n)}}Ke().catch(u=>{document.getElementById("output").textContent=`Failed to initialize Ruby VM: ${u.message}`,console.error(u)});document.getElementById("execute").addEventListener("click",je);document.getElementById("editor").addEventListener("keydown",u=>{(u.ctrlKey||u.metaKey)&&u.key==="Enter"&&(u.preventDefault(),je())});
