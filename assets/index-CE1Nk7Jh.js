(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const t of a)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function r(a){const t={};return a.integrity&&(t.integrity=a.integrity),a.referrerPolicy&&(t.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?t.credentials="include":a.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(a){if(a.ep)return;a.ep=!0;const t=r(a);fetch(a.href,t)}})();const re=0,ne=1,w=0,p=8,M=20,$=28,se=31,ke=37,A=44,Oe=52,k=54,ie=55,m=58,Q=63,oe=76,ae=64;class L{static read_bytes(e,r){const s=new L;return s.buf=e.getUint32(r,!0),s.buf_len=e.getUint32(r+4,!0),s}static read_bytes_array(e,r,s){const a=[];for(let t=0;t<s;t++)a.push(L.read_bytes(e,r+8*t));return a}}class C{static read_bytes(e,r){const s=new C;return s.buf=e.getUint32(r,!0),s.buf_len=e.getUint32(r+4,!0),s}static read_bytes_array(e,r,s){const a=[];for(let t=0;t<s;t++)a.push(C.read_bytes(e,r+8*t));return a}}const Fe=0,Ae=1,he=2,I=3,H=4;class K{head_length(){return 24}name_length(){return this.dir_name.byteLength}write_head_bytes(e,r){e.setBigUint64(r,this.d_next,!0),e.setBigUint64(r+8,this.d_ino,!0),e.setUint32(r+16,this.dir_name.length,!0),e.setUint8(r+20,this.d_type)}write_name_bytes(e,r,s){e.set(this.dir_name.slice(0,Math.min(this.dir_name.byteLength,s)),r)}constructor(e,r,s){this.d_ino=0n;const a=new TextEncoder().encode(r);this.d_next=e,this.d_namlen=a.byteLength,this.d_type=s,this.dir_name=a}}const De=1;class be{write_bytes(e,r){e.setUint8(r,this.fs_filetype),e.setUint16(r+2,this.fs_flags,!0),e.setBigUint64(r+8,this.fs_rights_base,!0),e.setBigUint64(r+16,this.fs_rights_inherited,!0)}constructor(e,r){this.fs_rights_base=0n,this.fs_rights_inherited=0n,this.fs_filetype=e,this.fs_flags=r}}const Y=1,N=2,le=4,ue=8;class _e{write_bytes(e,r){e.setBigUint64(r,this.dev,!0),e.setBigUint64(r+8,this.ino,!0),e.setUint8(r+16,this.filetype),e.setBigUint64(r+24,this.nlink,!0),e.setBigUint64(r+32,this.size,!0),e.setBigUint64(r+38,this.atim,!0),e.setBigUint64(r+46,this.mtim,!0),e.setBigUint64(r+52,this.ctim,!0)}constructor(e,r){this.dev=0n,this.ino=0n,this.nlink=0n,this.atim=0n,this.mtim=0n,this.ctim=0n,this.filetype=e,this.size=r}}const Se=0;class Pe{write_bytes(e,r){e.setUint32(r,this.pr_name.byteLength,!0)}constructor(e){this.pr_name=new TextEncoder().encode(e)}}class Z{static dir(e){const r=new Z;return r.tag=Se,r.inner=new Pe(e),r}write_bytes(e,r){e.setUint32(r,this.tag,!0),this.inner.write_bytes(e,r+4)}}let Ve=class{enable(e){this.log=Ne(e===void 0?!0:e,this.prefix)}get enabled(){return this.isEnabled}constructor(e){this.isEnabled=e,this.prefix="wasi:",this.enable(e)}};function Ne(u,e){return u?console.log.bind(console,"%c%s","color: #265BA0",e):()=>{}}const x=new Ve(!1);class ce extends Error{constructor(e){super("exit with exit code "+e),this.code=e}}let Be=class{start(e){this.inst=e;try{return e.exports._start(),0}catch(r){if(r instanceof ce)return r.code;throw r}}initialize(e){this.inst=e,e.exports._initialize&&e.exports._initialize()}constructor(e,r,s,a={}){this.args=[],this.env=[],this.fds=[],x.enable(a.debug),this.args=e,this.env=r,this.fds=s;const t=this;this.wasiImport={args_sizes_get(n,i){const o=new DataView(t.inst.exports.memory.buffer);o.setUint32(n,t.args.length,!0);let l=0;for(const c of t.args)l+=c.length+1;return o.setUint32(i,l,!0),x.log(o.getUint32(n,!0),o.getUint32(i,!0)),0},args_get(n,i){const o=new DataView(t.inst.exports.memory.buffer),l=new Uint8Array(t.inst.exports.memory.buffer),c=i;for(let f=0;f<t.args.length;f++){o.setUint32(n,i,!0),n+=4;const d=new TextEncoder().encode(t.args[f]);l.set(d,i),o.setUint8(i+d.length,0),i+=d.length+1}return x.enabled&&x.log(new TextDecoder("utf-8").decode(l.slice(c,i))),0},environ_sizes_get(n,i){const o=new DataView(t.inst.exports.memory.buffer);o.setUint32(n,t.env.length,!0);let l=0;for(const c of t.env)l+=c.length+1;return o.setUint32(i,l,!0),x.log(o.getUint32(n,!0),o.getUint32(i,!0)),0},environ_get(n,i){const o=new DataView(t.inst.exports.memory.buffer),l=new Uint8Array(t.inst.exports.memory.buffer),c=i;for(let f=0;f<t.env.length;f++){o.setUint32(n,i,!0),n+=4;const d=new TextEncoder().encode(t.env[f]);l.set(d,i),o.setUint8(i+d.length,0),i+=d.length+1}return x.enabled&&x.log(new TextDecoder("utf-8").decode(l.slice(c,i))),0},clock_res_get(n,i){let o;switch(n){case ne:{o=5000n;break}case re:{o=1000000n;break}default:return Oe}return new DataView(t.inst.exports.memory.buffer).setBigUint64(i,o,!0),w},clock_time_get(n,i,o){const l=new DataView(t.inst.exports.memory.buffer);if(n===re)l.setBigUint64(o,BigInt(new Date().getTime())*1000000n,!0);else if(n==ne){let c;try{c=BigInt(Math.round(performance.now()*1e6))}catch{c=0n}l.setBigUint64(o,c,!0)}else l.setBigUint64(o,0n,!0);return 0},fd_advise(n,i,o,l){return t.fds[n]!=null?w:p},fd_allocate(n,i,o){return t.fds[n]!=null?t.fds[n].fd_allocate(i,o):p},fd_close(n){if(t.fds[n]!=null){const i=t.fds[n].fd_close();return t.fds[n]=void 0,i}else return p},fd_datasync(n){return t.fds[n]!=null?t.fds[n].fd_sync():p},fd_fdstat_get(n,i){if(t.fds[n]!=null){const{ret:o,fdstat:l}=t.fds[n].fd_fdstat_get();return l?.write_bytes(new DataView(t.inst.exports.memory.buffer),i),o}else return p},fd_fdstat_set_flags(n,i){return t.fds[n]!=null?t.fds[n].fd_fdstat_set_flags(i):p},fd_fdstat_set_rights(n,i,o){return t.fds[n]!=null?t.fds[n].fd_fdstat_set_rights(i,o):p},fd_filestat_get(n,i){if(t.fds[n]!=null){const{ret:o,filestat:l}=t.fds[n].fd_filestat_get();return l?.write_bytes(new DataView(t.inst.exports.memory.buffer),i),o}else return p},fd_filestat_set_size(n,i){return t.fds[n]!=null?t.fds[n].fd_filestat_set_size(i):p},fd_filestat_set_times(n,i,o,l){return t.fds[n]!=null?t.fds[n].fd_filestat_set_times(i,o,l):p},fd_pread(n,i,o,l,c){const f=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const h=L.read_bytes_array(f,i,o);let _=0;for(const b of h){const{ret:y,data:v}=t.fds[n].fd_pread(b.buf_len,l);if(y!=w)return f.setUint32(c,_,!0),y;if(d.set(v,b.buf),_+=v.length,l+=BigInt(v.length),v.length!=b.buf_len)break}return f.setUint32(c,_,!0),w}else return p},fd_prestat_get(n,i){const o=new DataView(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const{ret:l,prestat:c}=t.fds[n].fd_prestat_get();return c?.write_bytes(o,i),l}else return p},fd_prestat_dir_name(n,i,o){if(t.fds[n]!=null){const{ret:l,prestat:c}=t.fds[n].fd_prestat_get();if(c==null)return l;const f=c.inner.pr_name;return new Uint8Array(t.inst.exports.memory.buffer).set(f.slice(0,o),i),f.byteLength>o?ke:w}else return p},fd_pwrite(n,i,o,l,c){const f=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const h=C.read_bytes_array(f,i,o);let _=0;for(const b of h){const y=d.slice(b.buf,b.buf+b.buf_len),{ret:v,nwritten:R}=t.fds[n].fd_pwrite(y,l);if(v!=w)return f.setUint32(c,_,!0),v;if(_+=R,l+=BigInt(R),R!=y.byteLength)break}return f.setUint32(c,_,!0),w}else return p},fd_read(n,i,o,l){const c=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const d=L.read_bytes_array(c,i,o);let h=0;for(const _ of d){const{ret:b,data:y}=t.fds[n].fd_read(_.buf_len);if(b!=w)return c.setUint32(l,h,!0),b;if(f.set(y,_.buf),h+=y.length,y.length!=_.buf_len)break}return c.setUint32(l,h,!0),w}else return p},fd_readdir(n,i,o,l,c){const f=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){let h=0;for(;;){const{ret:_,dirent:b}=t.fds[n].fd_readdir_single(l);if(_!=0)return f.setUint32(c,h,!0),_;if(b==null)break;if(o-h<b.head_length()){h=o;break}const y=new ArrayBuffer(b.head_length());if(b.write_head_bytes(new DataView(y),0),d.set(new Uint8Array(y).slice(0,Math.min(y.byteLength,o-h)),i),i+=b.head_length(),h+=b.head_length(),o-h<b.name_length()){h=o;break}b.write_name_bytes(d,i,o-h),i+=b.name_length(),h+=b.name_length(),l=b.d_next}return f.setUint32(c,h,!0),0}else return p},fd_renumber(n,i){if(t.fds[n]!=null&&t.fds[i]!=null){const o=t.fds[i].fd_close();return o!=0?o:(t.fds[i]=t.fds[n],t.fds[n]=void 0,0)}else return p},fd_seek(n,i,o,l){const c=new DataView(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const{ret:f,offset:d}=t.fds[n].fd_seek(i,o);return c.setBigInt64(l,d,!0),f}else return p},fd_sync(n){return t.fds[n]!=null?t.fds[n].fd_sync():p},fd_tell(n,i){const o=new DataView(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const{ret:l,offset:c}=t.fds[n].fd_tell();return o.setBigUint64(i,c,!0),l}else return p},fd_write(n,i,o,l){const c=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const d=C.read_bytes_array(c,i,o);let h=0;for(const _ of d){const b=f.slice(_.buf,_.buf+_.buf_len),{ret:y,nwritten:v}=t.fds[n].fd_write(b);if(y!=w)return c.setUint32(l,h,!0),y;if(h+=v,v!=b.byteLength)break}return c.setUint32(l,h,!0),w}else return p},path_create_directory(n,i,o){const l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const c=new TextDecoder("utf-8").decode(l.slice(i,i+o));return t.fds[n].path_create_directory(c)}else return p},path_filestat_get(n,i,o,l,c){const f=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const h=new TextDecoder("utf-8").decode(d.slice(o,o+l)),{ret:_,filestat:b}=t.fds[n].path_filestat_get(i,h);return b?.write_bytes(f,c),_}else return p},path_filestat_set_times(n,i,o,l,c,f,d){const h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const _=new TextDecoder("utf-8").decode(h.slice(o,o+l));return t.fds[n].path_filestat_set_times(i,_,c,f,d)}else return p},path_link(n,i,o,l,c,f,d){const h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null&&t.fds[c]!=null){const _=new TextDecoder("utf-8").decode(h.slice(o,o+l)),b=new TextDecoder("utf-8").decode(h.slice(f,f+d)),{ret:y,inode_obj:v}=t.fds[n].path_lookup(_,i);return v==null?y:t.fds[c].path_link(b,v,!1)}else return p},path_open(n,i,o,l,c,f,d,h,_){const b=new DataView(t.inst.exports.memory.buffer),y=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const v=new TextDecoder("utf-8").decode(y.slice(o,o+l));x.log(v);const{ret:R,fd_obj:ee}=t.fds[n].path_open(i,v,c,f,d,h);if(R!=0)return R;t.fds.push(ee);const V=t.fds.length-1;return b.setUint32(_,V,!0),0}else return p},path_readlink(n,i,o,l,c,f){const d=new DataView(t.inst.exports.memory.buffer),h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const _=new TextDecoder("utf-8").decode(h.slice(i,i+o));x.log(_);const{ret:b,data:y}=t.fds[n].path_readlink(_);if(y!=null){const v=new TextEncoder().encode(y);if(v.length>c)return d.setUint32(f,0,!0),p;h.set(v,l),d.setUint32(f,v.length,!0)}return b}else return p},path_remove_directory(n,i,o){const l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const c=new TextDecoder("utf-8").decode(l.slice(i,i+o));return t.fds[n].path_remove_directory(c)}else return p},path_rename(n,i,o,l,c,f){const d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null&&t.fds[l]!=null){const h=new TextDecoder("utf-8").decode(d.slice(i,i+o)),_=new TextDecoder("utf-8").decode(d.slice(c,c+f));let{ret:b,inode_obj:y}=t.fds[n].path_unlink(h);if(y==null)return b;if(b=t.fds[l].path_link(_,y,!0),b!=w&&t.fds[n].path_link(h,y,!0)!=w)throw"path_link should always return success when relinking an inode back to the original place";return b}else return p},path_symlink(n,i,o,l,c){const f=new Uint8Array(t.inst.exports.memory.buffer);return t.fds[o]!=null?(new TextDecoder("utf-8").decode(f.slice(n,n+i)),new TextDecoder("utf-8").decode(f.slice(l,l+c)),m):p},path_unlink_file(n,i,o){const l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){const c=new TextDecoder("utf-8").decode(l.slice(i,i+o));return t.fds[n].path_unlink_file(c)}else return p},poll_oneoff(n,i,o){throw"async io not supported"},proc_exit(n){throw new ce(n)},proc_raise(n){throw"raised signal "+n},sched_yield(){},random_get(n,i){const o=new Uint8Array(t.inst.exports.memory.buffer);for(let l=0;l<i;l++)o[n+l]=Math.random()*256|0},sock_recv(n,i,o){throw"sockets not supported"},sock_send(n,i,o){throw"sockets not supported"},sock_shutdown(n,i){throw"sockets not supported"},sock_accept(n,i){throw"sockets not supported"}}}};class pe{fd_allocate(e,r){return m}fd_close(){return 0}fd_fdstat_get(){return{ret:m,fdstat:null}}fd_fdstat_set_flags(e){return m}fd_fdstat_set_rights(e,r){return m}fd_filestat_get(){return{ret:m,filestat:null}}fd_filestat_set_size(e){return m}fd_filestat_set_times(e,r,s){return m}fd_pread(e,r){return{ret:m,data:new Uint8Array}}fd_prestat_get(){return{ret:m,prestat:null}}fd_pwrite(e,r){return{ret:m,nwritten:0}}fd_read(e){return{ret:m,data:new Uint8Array}}fd_readdir_single(e){return{ret:m,dirent:null}}fd_seek(e,r){return{ret:m,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:m,offset:0n}}fd_write(e){return{ret:m,nwritten:0}}path_create_directory(e){return m}path_filestat_get(e,r){return{ret:m,filestat:null}}path_filestat_set_times(e,r,s,a,t){return m}path_link(e,r,s){return m}path_unlink(e){return{ret:m,inode_obj:null}}path_lookup(e,r){return{ret:m,inode_obj:null}}path_open(e,r,s,a,t,n){return{ret:k,fd_obj:null}}path_readlink(e){return{ret:m,data:null}}path_remove_directory(e){return m}path_rename(e,r,s){return m}path_unlink_file(e){return m}}class ge{}class J extends pe{fd_allocate(e,r){if(!(this.file.size>e+r)){const s=new Uint8Array(Number(e+r));s.set(this.file.data,0),this.file.data=s}return w}fd_fdstat_get(){return{ret:0,fdstat:new be(H,0)}}fd_filestat_set_size(e){if(this.file.size>e)this.file.data=new Uint8Array(this.file.data.buffer.slice(0,Number(e)));else{const r=new Uint8Array(Number(e));r.set(this.file.data,0),this.file.data=r}return w}fd_read(e){const r=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(e)));return this.file_pos+=BigInt(r.length),{ret:0,data:r}}fd_pread(e,r){return{ret:0,data:this.file.data.slice(Number(r),Number(r+BigInt(e)))}}fd_seek(e,r){let s;switch(r){case Fe:s=e;break;case Ae:s=this.file_pos+e;break;case he:s=BigInt(this.file.data.byteLength)+e;break;default:return{ret:$,offset:0n}}return s<0?{ret:$,offset:0n}:(this.file_pos=s,{ret:0,offset:this.file_pos})}fd_tell(){return{ret:0,offset:this.file_pos}}fd_write(e){if(this.file.readonly)return{ret:p,nwritten:0};if(this.file_pos+BigInt(e.byteLength)>this.file.size){const r=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(e.byteLength))),this.file.data.set(r)}return this.file.data.set(e,Number(this.file_pos)),this.file_pos+=BigInt(e.byteLength),{ret:0,nwritten:e.byteLength}}fd_pwrite(e,r){if(this.file.readonly)return{ret:p,nwritten:0};if(r+BigInt(e.byteLength)>this.file.size){const s=this.file.data;this.file.data=new Uint8Array(Number(r+BigInt(e.byteLength))),this.file.data.set(s)}return this.file.data.set(e,Number(r)),{ret:0,nwritten:e.byteLength}}fd_filestat_get(){return{ret:0,filestat:this.file.stat()}}constructor(e){super(),this.file_pos=0n,this.file=e}}class ye extends pe{fd_seek(e,r){return{ret:p,offset:0n}}fd_tell(){return{ret:p,offset:0n}}fd_allocate(e,r){return p}fd_fdstat_get(){return{ret:0,fdstat:new be(I,0)}}fd_readdir_single(e){if(x.enabled&&(x.log("readdir_single",e),x.log(e,this.dir.contents.keys())),e==0n)return{ret:w,dirent:new K(1n,".",I)};if(e==1n)return{ret:w,dirent:new K(2n,"..",I)};if(e>=BigInt(this.dir.contents.size)+2n)return{ret:0,dirent:null};const[r,s]=Array.from(this.dir.contents.entries())[Number(e-2n)];return{ret:0,dirent:new K(e+1n,r,s.stat().filetype)}}path_filestat_get(e,r){const{ret:s,path:a}=U.from(r);if(a==null)return{ret:s,filestat:null};const{ret:t,entry:n}=this.dir.get_entry_for_path(a);return n==null?{ret:t,filestat:null}:{ret:0,filestat:n.stat()}}path_lookup(e,r){const{ret:s,path:a}=U.from(e);if(a==null)return{ret:s,inode_obj:null};const{ret:t,entry:n}=this.dir.get_entry_for_path(a);return n==null?{ret:t,inode_obj:null}:{ret:w,inode_obj:n}}path_open(e,r,s,a,t,n){const{ret:i,path:o}=U.from(r);if(o==null)return{ret:i,fd_obj:null};let{ret:l,entry:c}=this.dir.get_entry_for_path(o);if(c==null){if(l!=A)return{ret:l,fd_obj:null};if((s&Y)==Y){const{ret:f,entry:d}=this.dir.create_entry_for_path(r,(s&N)==N);if(d==null)return{ret:f,fd_obj:null};c=d}else return{ret:A,fd_obj:null}}else if((s&le)==le)return{ret:M,fd_obj:null};return(s&N)==N&&c.stat().filetype!==I?{ret:k,fd_obj:null}:c.path_open(s,a,n)}path_create_directory(e){return this.path_open(0,e,Y|N,0n,0n,0).ret}path_link(e,r,s){const{ret:a,path:t}=U.from(e);if(t==null)return a;if(t.is_dir)return A;const{ret:n,parent_entry:i,filename:o,entry:l}=this.dir.get_parent_dir_and_entry_for_path(t,!0);if(i==null||o==null)return n;if(l!=null){const c=r.stat().filetype==I,f=l.stat().filetype==I;if(c&&f)if(s&&l instanceof D){if(l.contents.size!=0)return ie}else return M;else{if(c&&!f)return k;if(!c&&f)return se;if(!(r.stat().filetype==H&&l.stat().filetype==H))return M}}return!s&&r.stat().filetype==I?Q:(i.contents.set(o,r),w)}path_unlink(e){const{ret:r,path:s}=U.from(e);if(s==null)return{ret:r,inode_obj:null};const{ret:a,parent_entry:t,filename:n,entry:i}=this.dir.get_parent_dir_and_entry_for_path(s,!0);return t==null||n==null?{ret:a,inode_obj:null}:i==null?{ret:A,inode_obj:null}:(t.contents.delete(n),{ret:w,inode_obj:i})}path_unlink_file(e){const{ret:r,path:s}=U.from(e);if(s==null)return r;const{ret:a,parent_entry:t,filename:n,entry:i}=this.dir.get_parent_dir_and_entry_for_path(s,!1);return t==null||n==null||i==null?a:i.stat().filetype===I?se:(t.contents.delete(n),w)}path_remove_directory(e){const{ret:r,path:s}=U.from(e);if(s==null)return r;const{ret:a,parent_entry:t,filename:n,entry:i}=this.dir.get_parent_dir_and_entry_for_path(s,!1);return t==null||n==null||i==null?a:!(i instanceof D)||i.stat().filetype!==I?k:i.contents.size!==0?ie:t.contents.delete(n)?w:A}fd_filestat_get(){return{ret:0,filestat:this.dir.stat()}}fd_filestat_set_size(e){return p}fd_read(e){return{ret:p,data:new Uint8Array}}fd_pread(e,r){return{ret:p,data:new Uint8Array}}fd_write(e){return{ret:p,nwritten:0}}fd_pwrite(e,r){return{ret:p,nwritten:0}}constructor(e){super(),this.dir=e}}class Le extends ye{fd_prestat_get(){return{ret:0,prestat:Z.dir(this.prestat_name)}}constructor(e,r){super(new D(r)),this.prestat_name=e}}class z extends ge{path_open(e,r,s){if(this.readonly&&(r&BigInt(ae))==BigInt(ae))return{ret:Q,fd_obj:null};if((e&ue)==ue){if(this.readonly)return{ret:Q,fd_obj:null};this.data=new Uint8Array([])}const a=new J(this);return s&De&&a.fd_seek(0n,he),{ret:w,fd_obj:a}}get size(){return BigInt(this.data.byteLength)}stat(){return new _e(H,this.size)}constructor(e,r){super(),this.data=new Uint8Array(e),this.readonly=!!r?.readonly}}let U=class we{static from(e){const r=new we;if(r.is_dir=e.endsWith("/"),e.startsWith("/"))return{ret:oe,path:null};if(e.includes("\0"))return{ret:$,path:null};for(const s of e.split("/"))if(!(s===""||s===".")){if(s===".."){if(r.parts.pop()==null)return{ret:oe,path:null};continue}r.parts.push(s)}return{ret:w,path:r}}to_path_string(){let e=this.parts.join("/");return this.is_dir&&(e+="/"),e}constructor(){this.parts=[],this.is_dir=!1}};class D extends ge{path_open(e,r,s){return{ret:w,fd_obj:new ye(this)}}stat(){return new _e(I,0n)}get_entry_for_path(e){let r=this;for(const s of e.parts){if(!(r instanceof D))return{ret:k,entry:null};const a=r.contents.get(s);if(a!==void 0)r=a;else return x.log(s),{ret:A,entry:null}}return e.is_dir&&r.stat().filetype!=I?{ret:k,entry:null}:{ret:w,entry:r}}get_parent_dir_and_entry_for_path(e,r){const s=e.parts.pop();if(s===void 0)return{ret:$,parent_entry:null,filename:null,entry:null};const{ret:a,entry:t}=this.get_entry_for_path(e);if(t==null)return{ret:a,parent_entry:null,filename:null,entry:null};if(!(t instanceof D))return{ret:k,parent_entry:null,filename:null,entry:null};const n=t.contents.get(s);return n===void 0?r?{ret:w,parent_entry:t,filename:s,entry:null}:{ret:A,parent_entry:null,filename:null,entry:null}:e.is_dir&&n.stat().filetype!=I?{ret:k,parent_entry:null,filename:null,entry:null}:{ret:w,parent_entry:t,filename:s,entry:n}}create_entry_for_path(e,r){const{ret:s,path:a}=U.from(e);if(a==null)return{ret:s,entry:null};let{ret:t,parent_entry:n,filename:i,entry:o}=this.get_parent_dir_and_entry_for_path(a,!0);if(n==null||i==null)return{ret:t,entry:null};if(o!=null)return{ret:M,entry:null};x.log("create",a);let l;return r?l=new D(new Map):l=new z(new ArrayBuffer(0)),n.contents.set(i,l),o=l,{ret:w,entry:o}}constructor(e){super(),e instanceof Array?this.contents=new Map(e):this.contents=e}}function Ce({stdout:u,stderr:e}={stdout:console.log,stderr:console.warn}){let r,s;function a(){if(typeof r>"u")throw new Error("Memory is not set");return(s===void 0||s.buffer.byteLength===0)&&(s=new DataView(r.buffer)),s}const t=new TextDecoder;return{addToImports(n){const i=n.wasi_snapshot_preview1,o=i.fd_write;i.fd_write=(f,d,h,_)=>{if(f!==1&&f!==2)return o(f,d,h,_);const b=a(),y=Array.from({length:h},(V,Re)=>{const te=d+Re*8,Ue=b.getUint32(te,!0),Te=b.getUint32(te+4,!0);return new Uint8Array(r.buffer,Ue,Te)});let v=0,R="";for(const V of y)R+=t.decode(V),v+=V.byteLength;return b.setUint32(_,v,!0),(f===1?u:e)(R),0};const l=i.fd_filestat_get;i.fd_filestat_get=(f,d)=>{if(f!==1&&f!==2)return l(f,d);const h=a(),_=l(f,d);if(_!==0)return _;const b=d+0;return h.setUint8(b,2),0};const c=i.fd_fdstat_get;i.fd_fdstat_get=(f,d)=>{if(f!==1&&f!==2)return c(f,d);const h=a(),_=d+0;h.setUint8(_,2);const b=d+8;return h.setBigUint64(b,BigInt(64),!0),0}},setMemory(n){r=n}}}let X=new DataView(new ArrayBuffer);function g(u){return X.buffer!==u.buffer&&(X=new DataView(u.buffer)),X}function Me(u){return u>>>0}const T=new TextDecoder("utf-8"),Je=new TextEncoder("utf-8");function P(u,e,r){if(typeof u!="string")throw new TypeError("expected a string");if(u.length===0)return F=0,1;let s=0,a=0,t=0;for(;u.length>0;){a=e(a,s,1,s+u.length),s+=u.length;const{read:n,written:i}=Je.encodeInto(u,new Uint8Array(r.buffer,a+t,s-t));t+=i,u=u.slice(n)}return s>t&&(a=e(a,s,1,t)),F=t,a}let F=0;class me{constructor(){this.list=[],this.head=0}insert(e){this.head>=this.list.length&&this.list.push({next:this.list.length+1,val:void 0});const r=this.head,s=this.list[r];return this.head=s.next,s.next=-1,s.val=e,r}get(e){if(e>=this.list.length)throw new RangeError("handle index not valid");const r=this.list[e];if(r.next===-1)return r.val;throw new RangeError("handle index not valid")}remove(e){const r=this.get(e),s=this.list[e];return s.val=void 0,s.next=this.head,this.head=e,r}}function G(){throw new RangeError("invalid variant discriminant for bool")}class ve{constructor(){this._resource0_slab=new me}addToImports(e){"canonical_abi"in e||(e.canonical_abi={}),e.canonical_abi["resource_drop_rb-abi-value"]=r=>{this._resource0_slab.remove(r).drop()},e.canonical_abi["resource_clone_rb-abi-value"]=r=>{const s=this._resource0_slab.get(r);return this._resource0_slab.insert(s.clone())},e.canonical_abi["resource_get_rb-abi-value"]=r=>this._resource0_slab.get(r)._wasm_val,e.canonical_abi["resource_new_rb-abi-value"]=r=>(this._registry0,this._resource0_slab.insert(new B(r,this)))}async instantiate(e,r){if(r=r||{},this.addToImports(r),e instanceof WebAssembly.Instance)this.instance=e;else if(e instanceof WebAssembly.Module)this.instance=await WebAssembly.instantiate(e,r);else if(e instanceof ArrayBuffer||e instanceof Uint8Array){const{instance:s}=await WebAssembly.instantiate(e,r);this.instance=s}else{const{instance:s}=await WebAssembly.instantiateStreaming(e,r);this.instance=s}this._exports=this.instance.exports,this._registry0=new FinalizationRegistry(this._exports["canonical_abi_drop_rb-abi-value"])}rubyShowVersion(){this._exports["ruby-show-version: func() -> ()"]()}rubyInit(e){const r=this._exports.memory,s=this._exports.cabi_realloc,a=e,t=a.length,n=s(0,0,4,t*8);for(let i=0;i<a.length;i++){const o=a[i],l=n+i*8,c=P(o,s,r),f=F;g(r).setInt32(l+4,f,!0),g(r).setInt32(l+0,c,!0)}this._exports["ruby-init: func(args: list<string>) -> ()"](n,t)}rubyInitLoadpath(){this._exports["ruby-init-loadpath: func() -> ()"]()}rbEvalStringProtect(e){const r=this._exports.memory,s=this._exports.cabi_realloc,a=P(e,s,r),t=F,n=this._exports["rb-eval-string-protect: func(str: string) -> tuple<handle<rb-abi-value>, s32>"](a,t);return[this._resource0_slab.remove(g(r).getInt32(n+0,!0)),g(r).getInt32(n+4,!0)]}rbFuncallvProtect(e,r,s){const a=this._exports.memory,t=this._exports.cabi_realloc,n=e;if(!(n instanceof B))throw new TypeError("expected instance of RbAbiValue");const i=s,o=i.length,l=t(0,0,4,o*4);for(let f=0;f<i.length;f++){const d=i[f],h=l+f*4,_=d;if(!(_ instanceof B))throw new TypeError("expected instance of RbAbiValue");g(a).setInt32(h+0,this._resource0_slab.insert(_.clone()),!0)}const c=this._exports["rb-funcallv-protect: func(recv: handle<rb-abi-value>, mid: u32, args: list<handle<rb-abi-value>>) -> tuple<handle<rb-abi-value>, s32>"](this._resource0_slab.insert(n.clone()),Me(r),l,o);return[this._resource0_slab.remove(g(a).getInt32(c+0,!0)),g(a).getInt32(c+4,!0)]}rbIntern(e){const r=this._exports.memory,s=this._exports.cabi_realloc,a=P(e,s,r),t=F;return this._exports["rb-intern: func(name: string) -> u32"](a,t)>>>0}rbErrinfo(){const e=this._exports["rb-errinfo: func() -> handle<rb-abi-value>"]();return this._resource0_slab.remove(e)}rbClearErrinfo(){this._exports["rb-clear-errinfo: func() -> ()"]()}rstringPtr(e){const r=this._exports.memory,s=e;if(!(s instanceof B))throw new TypeError("expected instance of RbAbiValue");const a=this._exports["rstring-ptr: func(value: handle<rb-abi-value>) -> string"](this._resource0_slab.insert(s.clone())),t=g(r).getInt32(a+0,!0),n=g(r).getInt32(a+4,!0),i=T.decode(new Uint8Array(r.buffer,t,n));return this._exports["cabi_post_rstring-ptr"](a),i}rbVmBugreport(){this._exports["rb-vm-bugreport: func() -> ()"]()}rbGcEnable(){const r=this._exports["rb-gc-enable: func() -> bool"]();return r==0?!1:r==1?!0:G()}rbGcDisable(){const r=this._exports["rb-gc-disable: func() -> bool"]();return r==0?!1:r==1?!0:G()}rbSetShouldProhibitRewind(e){const s=this._exports["rb-set-should-prohibit-rewind: func(new-value: bool) -> bool"](e?1:0);return s==0?!1:s==1?!0:G()}}class B{constructor(e,r){this._wasm_val=e,this._obj=r,this._refcnt=1,r._registry0.register(this,e,this)}clone(){return this._refcnt+=1,this}drop(){if(this._refcnt-=1,this._refcnt!==0)return;this._obj._registry0.unregister(this);const e=this._obj._exports["canonical_abi_drop_rb-abi-value"],r=this._wasm_val;delete this._obj,delete this._refcnt,delete this._wasm_val,e(r)}}function ze(u,e,r){"rb-js-abi-host"in u||(u["rb-js-abi-host"]={}),u["rb-js-abi-host"]["eval-js: func(code: string) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(a,t,n){const i=r("memory"),o=a,l=t,c=T.decode(new Uint8Array(i.buffer,o,l)),d=e.evalJs(c);switch(d.tag){case"success":{const h=d.val;g(i).setInt8(n+0,0,!0),g(i).setInt32(n+4,s.insert(h),!0);break}case"failure":{const h=d.val;g(i).setInt8(n+0,1,!0),g(i).setInt32(n+4,s.insert(h),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},u["rb-js-abi-host"]["is-js: func(value: handle<js-abi-value>) -> bool"]=function(a){return e.isJs(s.get(a))?1:0},u["rb-js-abi-host"]["instance-of: func(value: handle<js-abi-value>, klass: handle<js-abi-value>) -> bool"]=function(a,t){return e.instanceOf(s.get(a),s.get(t))?1:0},u["rb-js-abi-host"]["global-this: func() -> handle<js-abi-value>"]=function(){const a=e.globalThis();return s.insert(a)},u["rb-js-abi-host"]["int-to-js-number: func(value: s32) -> handle<js-abi-value>"]=function(a){const t=e.intToJsNumber(a);return s.insert(t)},u["rb-js-abi-host"]["float-to-js-number: func(value: float64) -> handle<js-abi-value>"]=function(a){const t=e.floatToJsNumber(a);return s.insert(t)},u["rb-js-abi-host"]["string-to-js-string: func(value: string) -> handle<js-abi-value>"]=function(a,t){const n=r("memory"),i=a,o=t,l=T.decode(new Uint8Array(n.buffer,i,o)),c=e.stringToJsString(l);return s.insert(c)},u["rb-js-abi-host"]["bool-to-js-bool: func(value: bool) -> handle<js-abi-value>"]=function(a){const t=a,n=e.boolToJsBool(t==0?!1:t==1?!0:G());return s.insert(n)},u["rb-js-abi-host"]["proc-to-js-function: func(value: u32) -> handle<js-abi-value>"]=function(a){const t=e.procToJsFunction(a>>>0);return s.insert(t)},u["rb-js-abi-host"]["rb-object-to-js-rb-value: func(raw-rb-abi-value: u32) -> handle<js-abi-value>"]=function(a){const t=e.rbObjectToJsRbValue(a>>>0);return s.insert(t)},u["rb-js-abi-host"]["js-value-to-string: func(value: handle<js-abi-value>) -> string"]=function(a,t){const n=r("memory"),i=r("cabi_realloc"),o=e.jsValueToString(s.get(a)),l=P(o,i,n),c=F;g(n).setInt32(t+4,c,!0),g(n).setInt32(t+0,l,!0)},u["rb-js-abi-host"]["js-value-to-integer: func(value: handle<js-abi-value>) -> variant { as-float(float64), bignum(string) }"]=function(a,t){const n=r("memory"),i=r("cabi_realloc"),l=e.jsValueToInteger(s.get(a));switch(l.tag){case"as-float":{const c=l.val;g(n).setInt8(t+0,0,!0),g(n).setFloat64(t+8,+c,!0);break}case"bignum":{const c=l.val;g(n).setInt8(t+0,1,!0);const f=P(c,i,n),d=F;g(n).setInt32(t+12,d,!0),g(n).setInt32(t+8,f,!0);break}default:throw new RangeError("invalid variant specified for RawInteger")}},u["rb-js-abi-host"]["export-js-value-to-host: func(value: handle<js-abi-value>) -> ()"]=function(a){e.exportJsValueToHost(s.get(a))},u["rb-js-abi-host"]["import-js-value-from-host: func() -> handle<js-abi-value>"]=function(){const a=e.importJsValueFromHost();return s.insert(a)},u["rb-js-abi-host"]["js-value-typeof: func(value: handle<js-abi-value>) -> string"]=function(a,t){const n=r("memory"),i=r("cabi_realloc"),o=e.jsValueTypeof(s.get(a)),l=P(o,i,n),c=F;g(n).setInt32(t+4,c,!0),g(n).setInt32(t+0,l,!0)},u["rb-js-abi-host"]["js-value-equal: func(lhs: handle<js-abi-value>, rhs: handle<js-abi-value>) -> bool"]=function(a,t){return e.jsValueEqual(s.get(a),s.get(t))?1:0},u["rb-js-abi-host"]["js-value-strictly-equal: func(lhs: handle<js-abi-value>, rhs: handle<js-abi-value>) -> bool"]=function(a,t){return e.jsValueStrictlyEqual(s.get(a),s.get(t))?1:0},u["rb-js-abi-host"]["reflect-apply: func(target: handle<js-abi-value>, this-argument: handle<js-abi-value>, arguments: list<handle<js-abi-value>>) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(a,t,n,i,o){const l=r("memory"),c=i,f=n,d=[];for(let b=0;b<c;b++){const y=f+b*4;d.push(s.get(g(l).getInt32(y+0,!0)))}const _=e.reflectApply(s.get(a),s.get(t),d);switch(_.tag){case"success":{const b=_.val;g(l).setInt8(o+0,0,!0),g(l).setInt32(o+4,s.insert(b),!0);break}case"failure":{const b=_.val;g(l).setInt8(o+0,1,!0),g(l).setInt32(o+4,s.insert(b),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},u["rb-js-abi-host"]["reflect-construct: func(target: handle<js-abi-value>, arguments: list<handle<js-abi-value>>) -> handle<js-abi-value>"]=function(a,t,n){const i=r("memory"),o=n,l=t,c=[];for(let d=0;d<o;d++){const h=l+d*4;c.push(s.get(g(i).getInt32(h+0,!0)))}const f=e.reflectConstruct(s.get(a),c);return s.insert(f)},u["rb-js-abi-host"]["reflect-delete-property: func(target: handle<js-abi-value>, property-key: string) -> bool"]=function(a,t,n){const i=r("memory"),o=t,l=n,c=T.decode(new Uint8Array(i.buffer,o,l));return e.reflectDeleteProperty(s.get(a),c)?1:0},u["rb-js-abi-host"]["reflect-get: func(target: handle<js-abi-value>, property-key: string) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(a,t,n,i){const o=r("memory"),l=t,c=n,f=T.decode(new Uint8Array(o.buffer,l,c)),h=e.reflectGet(s.get(a),f);switch(h.tag){case"success":{const _=h.val;g(o).setInt8(i+0,0,!0),g(o).setInt32(i+4,s.insert(_),!0);break}case"failure":{const _=h.val;g(o).setInt8(i+0,1,!0),g(o).setInt32(i+4,s.insert(_),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},u["rb-js-abi-host"]["reflect-get-own-property-descriptor: func(target: handle<js-abi-value>, property-key: string) -> handle<js-abi-value>"]=function(a,t,n){const i=r("memory"),o=t,l=n,c=T.decode(new Uint8Array(i.buffer,o,l)),f=e.reflectGetOwnPropertyDescriptor(s.get(a),c);return s.insert(f)},u["rb-js-abi-host"]["reflect-get-prototype-of: func(target: handle<js-abi-value>) -> handle<js-abi-value>"]=function(a){const t=e.reflectGetPrototypeOf(s.get(a));return s.insert(t)},u["rb-js-abi-host"]["reflect-has: func(target: handle<js-abi-value>, property-key: string) -> bool"]=function(a,t,n){const i=r("memory"),o=t,l=n,c=T.decode(new Uint8Array(i.buffer,o,l));return e.reflectHas(s.get(a),c)?1:0},u["rb-js-abi-host"]["reflect-is-extensible: func(target: handle<js-abi-value>) -> bool"]=function(a){return e.reflectIsExtensible(s.get(a))?1:0},u["rb-js-abi-host"]["reflect-own-keys: func(target: handle<js-abi-value>) -> list<handle<js-abi-value>>"]=function(a,t){const n=r("memory"),i=r("cabi_realloc"),l=e.reflectOwnKeys(s.get(a)),c=l.length,f=i(0,0,4,c*4);for(let d=0;d<l.length;d++){const h=l[d],_=f+d*4;g(n).setInt32(_+0,s.insert(h),!0)}g(n).setInt32(t+4,c,!0),g(n).setInt32(t+0,f,!0)},u["rb-js-abi-host"]["reflect-prevent-extensions: func(target: handle<js-abi-value>) -> bool"]=function(a){return e.reflectPreventExtensions(s.get(a))?1:0},u["rb-js-abi-host"]["reflect-set: func(target: handle<js-abi-value>, property-key: string, value: handle<js-abi-value>) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(a,t,n,i,o){const l=r("memory"),c=t,f=n,d=T.decode(new Uint8Array(l.buffer,c,f)),_=e.reflectSet(s.get(a),d,s.get(i));switch(_.tag){case"success":{const b=_.val;g(l).setInt8(o+0,0,!0),g(l).setInt32(o+4,s.insert(b),!0);break}case"failure":{const b=_.val;g(l).setInt8(o+0,1,!0),g(l).setInt32(o+4,s.insert(b),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},u["rb-js-abi-host"]["reflect-set-prototype-of: func(target: handle<js-abi-value>, prototype: handle<js-abi-value>) -> bool"]=function(a,t){return e.reflectSetPrototypeOf(s.get(a),s.get(t))?1:0},"canonical_abi"in u||(u.canonical_abi={});const s=new me;u.canonical_abi["resource_drop_js-abi-value"]=a=>{const t=s.remove(a);e.dropJsAbiValue&&e.dropJsAbiValue(t)}}class Ge extends ve{async setInstance(e){await this.instantiate(e)}}class We{constructor(){}setUnderlying(e){this.underlying=e}rubyShowVersion(){this.underlying.rubyShowVersion()}rubyInit(e){this.underlying.rubyInit(e)}rubyInitLoadpath(){this.underlying.rubyInitLoadpath()}rbEvalStringProtect(e){return this.underlying.rbEvalStringProtect(e)}rbFuncallvProtect(e,r,s){return this.underlying.rbFuncallvProtect(e,r,s)}rbIntern(e){return this.underlying.rbIntern(e)}rbErrinfo(){return this.underlying.rbErrinfo()}rbClearErrinfo(){return this.underlying.rbClearErrinfo()}rstringPtr(e){return this.underlying.rstringPtr(e)}rbVmBugreport(){this.underlying.rbVmBugreport()}rbGcEnable(){return this.underlying.rbGcEnable()}rbGcDisable(){return this.underlying.rbGcDisable()}rbSetShouldProhibitRewind(e){return this.underlying.rbSetShouldProhibitRewind(e)}async setInstance(e){}addToImports(e){}}class q{static async instantiateModule(e){var r,s;const{module:a,wasip1:t}=e,n=new q,i={wasi_snapshot_preview1:t.wasiImport};n.addToImports(i),(r=e.addToImports)===null||r===void 0||r.call(e,i);const o=await WebAssembly.instantiate(a,i);try{await n.setInstance(o)}catch(l){throw console.error('Failed to instantiate Ruby VM. Please make sure that you have added `gem "js"` to your Gemfile.'),l}return(s=e.setMemory)===null||s===void 0||s.call(e,o.exports.memory),t.initialize(o),n.initialize(e.args),{vm:n,instance:o}}static async instantiateComponent(e){let r;return"getCoreModule"in e?r=async a=>{const{instantiate:t,getCoreModule:n,wasip2:i}=e,{cli:o,clocks:l,filesystem:c,io:f,random:d,sockets:h,http:_}=i,b={"ruby:js/js-runtime":a,"wasi:cli/environment":o.environment,"wasi:cli/exit":o.exit,"wasi:cli/stderr":o.stderr,"wasi:cli/stdin":o.stdin,"wasi:cli/stdout":o.stdout,"wasi:cli/terminal-input":o.terminalInput,"wasi:cli/terminal-output":o.terminalOutput,"wasi:cli/terminal-stderr":o.terminalStderr,"wasi:cli/terminal-stdin":o.terminalStdin,"wasi:cli/terminal-stdout":o.terminalStdout,"wasi:clocks/monotonic-clock":l.monotonicClock,"wasi:clocks/wall-clock":l.wallClock,"wasi:filesystem/preopens":c.preopens,"wasi:filesystem/types":c.types,"wasi:io/error":f.error,"wasi:io/poll":f.poll,"wasi:io/streams":f.streams,"wasi:random/random":d.random,"wasi:sockets/tcp":h.tcp,"wasi:http/types":_.types,"wasi:http/incoming-handler":_.incomingHandler,"wasi:http/outgoing-handler":_.outgoingHandler};return(await t(n,b,e.instantiateCore)).rubyRuntime}:r=e.instantiate,{vm:await this._instantiate({},r)}}constructor(e){this.instance=null,this.interfaceState={hasJSFrameAfterRbFrame:!1};const r=s=>{const a=["setInstance","addToImports","instantiate","rbSetShouldProhibitRewind","rbGcDisable","rbGcEnable"],t=["constructor"].concat(a);for(const n of Object.getOwnPropertyNames(ve.prototype)){if(t.includes(n))continue;const i=s[n];typeof i=="function"&&(s[n]=(...o)=>{if(this.interfaceState.hasJSFrameAfterRbFrame){const c=this.guest.rbSetShouldProhibitRewind(!0),f=this.guest.rbGcDisable(),d=Reflect.apply(i,s,o);return this.guest.rbSetShouldProhibitRewind(c),f||this.guest.rbGcEnable(),d}else return Reflect.apply(i,s,o)})}return s};this.guest=r(e??new Ge),this.transport=new $e,this.exceptionFormatter=new He}static async _instantiate(e,r){const s=new We,a=new q(s);class t{constructor(l){this.underlying=l}}const n=a.getImports(o=>new t(o),o=>o.underlying),i=await r(Object.assign(Object.assign({},n),{throwProhibitRewindException:o=>{a.throwProhibitRewindException(o)},procToJsFunction:()=>{const o=new O(i.exportRbValueToJs(),a,a.privateObject());return new t((...l)=>o.call("call",...l.map(c=>a.wrap(c))).toJS())},rbObjectToJsRbValue:()=>{const o=new O(i.exportRbValueToJs(),a,a.privateObject());return new t(o)},JsAbiValue:t}));return s.setUnderlying(i),a.initialize(e.args),a}initialize(e=["ruby.wasm","-EUTF-8","-e_=0"]){const r=e.map(s=>s+"\0");this.guest.rubyInit(r);try{this.eval(`
        # Require Bundler standalone setup
        if File.exist?("/bundle/bundler/setup.rb")
          require "/bundle/bundler/setup.rb"
        elsif File.exist?("/bundle/setup.rb")
          # For non-CM builds, which doesn't use Bundler's standalone mode
          require "/bundle/setup.rb"
        end
      `)}catch(s){console.warn("Failed to load /bundle/setup",s)}}async setInstance(e){this.instance=e,await this.guest.setInstance(e)}addToImports(e){this.guest.addToImports(e),e["rb-js-abi-host"]={rb_wasm_throw_prohibit_rewind_exception:(r,s)=>{const a=this.instance.exports.memory,t=new TextDecoder().decode(new Uint8Array(a.buffer,r,s));this.throwProhibitRewindException(t)}},ze(e,this.getImports(r=>r,r=>r),r=>this.instance.exports[r])}throwProhibitRewindException(e){let r=`Ruby APIs that may rewind the VM stack are prohibited under nested VM operation (${e})
Nested VM operation means that the call stack has sandwitched JS frames like JS -> Ruby -> JS -> Ruby caused by something like \`window.rubyVM.eval("JS.global[:rubyVM].eval('Fiber.yield')")\`

Please check your call stack and make sure that you are **not** doing any of the following inside the nested Ruby frame:
  1. Switching fibers (e.g. Fiber#resume, Fiber.yield, and Fiber#transfer)
     Note that \`evalAsync\` JS API switches fibers internally
  2. Raising uncaught exceptions
     Please catch all exceptions inside the nested operation
  3. Calling Continuation APIs
`;const s=new O(this.guest.rbErrinfo(),this,this.privateObject());throw s.call("nil?").toString()==="false"&&(r+=`
`+this.exceptionFormatter.format(s,this,this.privateObject())),new de(r)}getImports(e,r){const s=t=>{for(const[n,i]of Object.entries(t))typeof i=="function"&&(t[n]=(...o)=>{const l=this.interfaceState.hasJSFrameAfterRbFrame;this.interfaceState.hasJSFrameAfterRbFrame=!0;const c=Reflect.apply(i,t,o);return this.interfaceState.hasJSFrameAfterRbFrame=l,c});return t};function a(t){return(...n)=>{try{return{tag:"success",val:t(...n)}}catch(i){if(i instanceof de)throw i;return{tag:"failure",val:e(i)}}}}return s({evalJs:a(t=>e(Function(t)())),isJs:t=>!0,globalThis:()=>{if(typeof globalThis<"u")return e(globalThis);if(typeof global<"u")return e(global);if(typeof window<"u")return e(window);throw new Error("unable to locate global object")},intToJsNumber:t=>e(t),floatToJsNumber:t=>e(t),stringToJsString:t=>e(t),boolToJsBool:t=>e(t),procToJsFunction:t=>{const n=this.rbValueOfPointer(t);return e((...i)=>n.call("call",...i.map(o=>this.wrap(o))).toJS())},rbObjectToJsRbValue:t=>e(this.rbValueOfPointer(t)),jsValueToString:t=>(t=r(t),String(t)),jsValueToInteger(t){return t=r(t),typeof t=="number"?{tag:"as-float",val:t}:typeof t=="bigint"?{tag:"bignum",val:BigInt(t).toString(10)+"\0"}:typeof t=="string"?{tag:"bignum",val:t+"\0"}:typeof t>"u"?{tag:"as-float",val:0}:{tag:"as-float",val:Number(t)}},exportJsValueToHost:t=>{this.transport.takeJsValue(r(t))},importJsValueFromHost:()=>e(this.transport.consumeJsValue()),instanceOf:(t,n)=>(n=r(n),typeof n=="function"?r(t)instanceof n:!1),jsValueTypeof(t){return typeof r(t)},jsValueEqual(t,n){return r(t)==r(n)},jsValueStrictlyEqual(t,n){return r(t)===r(n)},reflectApply:a((t,n,i)=>{const o=i.map(l=>r(l));return e(Reflect.apply(r(t),r(n),o))}),reflectConstruct:function(t,n){throw new Error("Function not implemented.")},reflectDeleteProperty:function(t,n){throw new Error("Function not implemented.")},reflectGet:a((t,n)=>e(r(t)[n])),reflectGetOwnPropertyDescriptor:function(t,n){throw new Error("Function not implemented.")},reflectGetPrototypeOf:function(t){throw new Error("Function not implemented.")},reflectHas:function(t,n){throw new Error("Function not implemented.")},reflectIsExtensible:function(t){throw new Error("Function not implemented.")},reflectOwnKeys:function(t){throw new Error("Function not implemented.")},reflectPreventExtensions:function(t){throw new Error("Function not implemented.")},reflectSet:a((t,n,i)=>e(Reflect.set(r(t),n,r(i)))),reflectSetPrototypeOf:function(t,n){throw new Error("Function not implemented.")}})}printVersion(){this.guest.rubyShowVersion()}eval(e){return W(this,this.privateObject(),e)}evalAsync(e){const r=this.eval("require 'js'; JS");return je(this,this.privateObject(),s=>{r.call("__eval_async_rb",this.wrap(e),s)})}wrap(e){return this.transport.importJsValue(e,this)}privateObject(){return{transport:this.transport,exceptionFormatter:this.exceptionFormatter}}rbValueOfPointer(e){const r=new B(e,this.guest);return new O(r,this,this.privateObject())}}class $e{constructor(){this._takenJsValue=null}takeJsValue(e){this._takenJsValue=e}consumeJsValue(){return this._takenJsValue}exportJsValue(e){return e.call("__export_to_js"),this._takenJsValue}importJsValue(e,r){return this._takenJsValue=e,r.eval('require "js"; JS::Object').call("__import_from_js")}}class O{constructor(e,r,s){this.inner=e,this.vm=r,this.privateObject=s}call(e,...r){const s=r.map(a=>a.inner);return new O(fe(this.vm,this.privateObject,this.inner,e,s),this.vm,this.privateObject)}callAsync(e,...r){const s=this.vm.eval("require 'js'; JS");return je(this.vm,this.privateObject,a=>{s.call("__call_async_method",this,this.vm.wrap(e),a,...r)})}[Symbol.toPrimitive](e){return e==="string"||e==="default"?this.toString():null}toString(){const e=fe(this.vm,this.privateObject,this.inner,"to_s",[]);return this.vm.guest.rstringPtr(e)}toJS(){const r=this.vm.eval("JS").call("try_convert",this);return r.call("nil?").toString()==="true"?null:this.privateObject.transport.exportJsValue(r)}}var j;(function(u){u[u.None=0]="None",u[u.Return=1]="Return",u[u.Break=2]="Break",u[u.Next=3]="Next",u[u.Retry=4]="Retry",u[u.Redo=5]="Redo",u[u.Raise=6]="Raise",u[u.Throw=7]="Throw",u[u.Fatal=8]="Fatal",u[u.Mask=15]="Mask"})(j||(j={}));class He{constructor(){this.literalsCache=null,this.isFormmatting=!1}format(e,r,s){class a extends Error{}if(this.isFormmatting)throw new a("Unexpected exception occurred during formatting exception message");this.isFormmatting=!0;try{return this._format(e,r,s)}finally{this.isFormmatting=!1}}_format(e,r,s){const[a,t,n]=(()=>{if(this.literalsCache==null){const c=[W(r,s,"0"),W(r,s,"1"),W(r,s,`"
"`)];return this.literalsCache=c,c}else return this.literalsCache})();let i,o,l;try{i=e.call("class").toString()}catch{i="unknown"}try{l=e.call("message").toString()}catch{l="unknown"}try{o=e.call("backtrace")}catch{return this.formatString(i,l)}if(o.call("nil?").toString()==="true")return this.formatString(i,l);try{const c=o.call("at",a),f=o.call("drop",t).call("join",n);return this.formatString(i,l,[c.toString(),f.toString()])}catch{return this.formatString(i,l)}}formatString(e,r,s){return s?`${s[0]}: ${r} (${e})
${s[1]}`:`${e}: ${r}`}}const xe=(u,e,r)=>{switch(u&j.Mask){case j.None:break;case j.Return:throw new E("unexpected return");case j.Next:throw new E("unexpected next");case j.Break:throw new E("unexpected break");case j.Redo:throw new E("unexpected redo");case j.Retry:throw new E("retry outside of rescue clause");case j.Throw:throw new E("unexpected throw");case j.Raise:case j.Fatal:const s=new O(e.guest.rbErrinfo(),e,r);throw s.call("nil?").toString()==="true"?new E("no exception object"):(e.guest.rbClearErrinfo(),new E(r.exceptionFormatter.format(s,e,r)));default:throw new E(`unknown error tag: ${u}`)}};function Ee(u,e){try{return e()}catch(r){if(r instanceof E)throw r;try{u.guest.rbVmBugreport()}catch(s){console.error("Tried to report internal Ruby VM state but failed: ",s)}if(r instanceof WebAssembly.RuntimeError&&r.message==="unreachable"){const s=new E(`Something went wrong in Ruby VM: ${r}`);throw s.stack=r.stack,s}else throw r}}const fe=(u,e,r,s,a)=>{const t=u.guest.rbIntern(s+"\0");return Ee(u,()=>{const[n,i]=u.guest.rbFuncallvProtect(r,t,a);return xe(i,u,e),n})},W=(u,e,r)=>Ee(u,()=>{const[s,a]=u.guest.rbEvalStringProtect(r+"\0");return xe(a,u,e),new O(s,u,e)});function je(u,e,r){return new Promise((s,a)=>{const t=u.wrap({resolve:s,reject:n=>{const i=new E(e.exceptionFormatter.format(n,u,e));a(i)}});r(t)})}class E extends Error{constructor(e){super(e)}}class de extends E{constructor(e){super("Ruby Fatal Error: "+e)}}const qe=async(u,e={})=>{var r,s;const a=[],t=Object.entries((r=e.env)!==null&&r!==void 0?r:{}).map(([f,d])=>`${f}=${d}`),n=[new J(new z([])),new J(new z([])),new J(new z([])),new Le("/",new Map)],i=new Be(a,t,n,{debug:!1}),o=!((s=e.consolePrint)!==null&&s!==void 0)||s?Ce():void 0,{vm:l,instance:c}=await q.instantiateModule({module:u,wasip1:i,addToImports:f=>{o?.addToImports(f)},setMemory:f=>{o?.setMemory(f)}});return{vm:l,wasi:i,instance:c}};let S=null;async function Ke(){const e=await(await fetch("https://cdn.jsdelivr.net/npm/@ruby/3.4-wasm-wasi@2.7.2/dist/ruby+stdlib.wasm")).arrayBuffer(),r=await WebAssembly.compile(e),{vm:s}=await qe(r);S=s;const t=await fetch("/ruby-wasm-study/lib/pesca.rb").then(n=>n.text());S.eval(t),console.log("Ruby VM initialized with Pesca module loaded"),document.getElementById("output").textContent=`Ready! Ruby VM initialized with Pesca module loaded.
`}function Ie(){const u=document.getElementById("editor").value,e=document.getElementById("output");if(console.log("Execute button clicked"),console.log("Code:",u),console.log("rubyVM:",S),!S){e.textContent="Error: Ruby VM not initialized yet. Please wait...";return}try{console.log("Attempting to eval...");const r=S.eval("'Hello from Ruby!'");console.log("Test result:",r);const s=S.eval(`
      require 'stringio'
      $captured_output = StringIO.new
      old_stdout = $stdout
      $stdout = $captured_output

      begin
        result = eval(<<-'RUBY_CODE'
        Pesca.reset!
${u}
      Pesca.assegna!
RUBY_CODE
        )
        $stdout = old_stdout
        output = $captured_output.string
        output += "=> " + result.inspect if !result.nil?
        output
      rescue => e
        $stdout = old_stdout
        "Error: " + e.class.to_s + ": " + e.message + "\\n" + e.backtrace.join("\\n")
      end
    `);console.log("Result:",s),e.textContent=s.toString()}catch(r){e.textContent=`Error: ${r.message}`,console.error("Error executing:",r)}}Ke().catch(u=>{document.getElementById("output").textContent=`Failed to initialize Ruby VM: ${u.message}`,console.error(u)});document.getElementById("execute").addEventListener("click",Ie);document.getElementById("editor").addEventListener("keydown",u=>{(u.ctrlKey||u.metaKey)&&u.key==="Enter"&&(u.preventDefault(),Ie())});
